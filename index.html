<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBT Professional System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }

    .loading-spinner {
      width: 120px;
      height: 120px;
      background-image: url('https://i.imgur.com/UVQedhI.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      animation: pulse 1.5s ease-in-out infinite;
      position: relative;
    }

    .loading-spinner::before {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      background: linear-gradient(45deg, 
        transparent 30%, 
        rgba(255, 255, 255, 0.8) 50%, 
        transparent 70%);
      animation: shiny 2s infinite;
      border-radius: 50%;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }

    @keyframes shiny {
      0% {
        transform: translateX(-150%) translateY(-150%) rotate(45deg);
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
      100% {
        transform: translateX(150%) translateY(150%) rotate(45deg);
        opacity: 0;
      }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast-success { background: #10b981; }
    .toast-error { background: #ef4444; }
    .toast-warning { background: #f59e0b; }
    .toast-info { background: #3b82f6; }

    .modal-backdrop {
      backdrop-filter: blur(4px);
    }

    .fade-in {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .question-number {
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .question-number:hover {
      transform: scale(1.05);
    }

    .status-unanswered {
      background: #9ca3af;
      color: white;
    }

    .status-answered {
      background: #3b82f6;
      color: white;
    }

    .status-doubtful {
      background: #fbbf24;
      color: #1f2937;
    }

    .status-current {
      box-shadow: 0 0 0 3px #ef4444;
    }

    .option-card {
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .option-card:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .option-selected {
      background: #dbeafe;
      border-color: #3b82f6;
      border-width: 2px;
    }

    .timer-warning {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-50%); }
    }

    .animate-marquee {
      animation: marquee 20s linear infinite;
    }

    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .progress-bar {
      transition: width 0.3s ease;
    }

    .difficulty-easy {
      background: #d1fae5;
      color: #065f46;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .difficulty-medium {
      background: #fef3c7;
      color: #92400e;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .difficulty-hard {
      background: #fee2e2;
      color: #991b1b;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .warning-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(239, 68, 68, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
      20%, 40%, 60%, 80% { transform: translateX(10px); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto"></div>
  <script>
    // ==================== FEATURES CONFIGURATION ====================
    // This CBT system includes:
    // - Student Login & Dashboard with cross-device resume
    // - Browser lock for closed-book exams
    // - Real-time progress tracking
    // - Admin panel for full management
    
    // ==================== SUPABASE CONFIGURATION ====================
    const SUPABASE_URL = 'https://zmbnltthcgpfsyxruawy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptYm5sdHRoY2dwZnN5eHJ1YXd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTI3MDYsImV4cCI6MjA4MDkyODcwNn0.tLQwIXAlAVqvNfVvZozv9TzUqoKfv71RMIiFV-9XtAQ';
    
    let supabase = null;
    let isSupabaseConfigured = false;

    // Initialize Supabase
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      isSupabaseConfigured = true;
      console.log('‚úÖ Supabase connected successfully!');
      
      // Test connection
      supabase.from('subjects').select('count').then(result => {
        if (result.error) {
          console.error('‚ùå Supabase connection test failed:', result.error);
          isSupabaseConfigured = false;
        } else {
          console.log('‚úÖ Supabase connection test passed');
        }
      });
    } catch (error) {
      console.error('‚ùå Error initializing Supabase:', error);
      isSupabaseConfigured = false;
    }

    // ==================== LOCAL STORAGE KEYS ====================
    const STORAGE_KEYS = {
      STUDENT_SESSION: 'cbt_student_session',
      TIMER_STATE: 'cbt_timer_state',
      EXAM_STATE: 'cbt_exam_state',
      ADMIN_STATE: 'cbt_admin_state',
      LOGGED_USER: 'cbt_logged_user'
    };

    // ==================== APPLICATION STATE ====================
    let appState = {
      currentView: 'role-selection',
      currentRole: null,
      loggedUser: null, // NEW: Store logged user data
      studentId: null,
      studentName: '',
      studentClass: '',
      examSessionId: null,
      examTitle: '',
      examSubject: '',
      currentQuestionIndex: 0,
      examQuestions: [],
      answers: new Map(),
      startTime: null,
      remainingSeconds: 0,
      timerInterval: null,
      currentSubjectFilter: 'all',
      selectedQuestions: new Set(),
      bulkEditMode: false,
      currentExamToken: '',
      currentExam: null, // NEW: Store current exam data including is_open_book
      violationCount: 0, // NEW: Track tab switch violations
      isInFullscreen: false // NEW: Track fullscreen status
    };

    // Initialize app function
    function initializeApp() {
      console.log('üöÄ Initializing CBT Application...');
      
      // Try to restore logged user
      const loggedUser = loadLoggedUser();
      if (loggedUser) {
        appState.loggedUser = loggedUser;
        if (loggedUser.role === 'student') {
          console.log('‚úÖ Restored student login');
          appState.currentRole = 'student';
          renderStudentDashboard();
          return;
        }
      }

      // Try to restore admin session
      const hasAdminState = loadAdminStateFromLocalStorage();
      if (hasAdminState && appState.currentRole === 'admin') {
        console.log('‚úÖ Restored admin session');
        renderAdminView();
        return;
      }

      console.log('‚úÖ Starting fresh - Rendering role selection');
      renderRoleSelection();
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }

    // ==================== STATE PERSISTENCE FUNCTIONS ====================
    
    function saveLoggedUser(userData) {
      try {
        localStorage.setItem(STORAGE_KEYS.LOGGED_USER, JSON.stringify(userData));
      } catch (error) {
        console.error('Error saving logged user:', error);
      }
    }

    function loadLoggedUser() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.LOGGED_USER);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (error) {
        console.error('Error loading logged user:', error);
      }
      return null;
    }

    function clearLoggedUser() {
      localStorage.removeItem(STORAGE_KEYS.LOGGED_USER);
    }

    function saveStateToLocalStorage() {
      try {
        if (appState.examSessionId) {
          const stateToSave = {
            studentId: appState.studentId,
            studentName: appState.studentName,
            studentClass: appState.studentClass,
            examSessionId: appState.examSessionId,
            examTitle: appState.examTitle,
            examSubject: appState.examSubject,
            currentQuestionIndex: appState.currentQuestionIndex,
            examQuestions: appState.examQuestions,
            answers: Array.from(appState.answers.entries()),
            remainingSeconds: appState.remainingSeconds,
            currentExamToken: appState.currentExamToken,
            violationCount: appState.violationCount
          };
          
          localStorage.setItem(STORAGE_KEYS.STUDENT_SESSION, JSON.stringify(stateToSave));
          localStorage.setItem(STORAGE_KEYS.TIMER_STATE, appState.remainingSeconds.toString());
        }
      } catch (error) {
        console.error('Error saving state:', error);
      }
    }

    function loadStateFromLocalStorage() {
      try {
        const savedState = localStorage.getItem(STORAGE_KEYS.STUDENT_SESSION);
        if (savedState) {
          const parsed = JSON.parse(savedState);
          appState.studentId = parsed.studentId;
          appState.studentName = parsed.studentName;
          appState.studentClass = parsed.studentClass;
          appState.examSessionId = parsed.examSessionId;
          appState.examTitle = parsed.examTitle || '';
          appState.examSubject = parsed.examSubject || '';
          appState.currentQuestionIndex = parsed.currentQuestionIndex || 0;
          appState.examQuestions = parsed.examQuestions || [];
          appState.totalQuestions = parsed.examQuestions ? parsed.examQuestions.length : 0;
          appState.answers = new Map(parsed.answers || []);
          appState.remainingSeconds = parsed.remainingSeconds || 0;
          appState.currentExamToken = parsed.currentExamToken || '';
          appState.violationCount = parsed.violationCount || 0;
          return true;
        }
      } catch (error) {
        console.error('Error loading state:', error);
      }
      return false;
    }

    function clearStateFromLocalStorage() {
      localStorage.removeItem(STORAGE_KEYS.STUDENT_SESSION);
      localStorage.removeItem(STORAGE_KEYS.TIMER_STATE);
      localStorage.removeItem(STORAGE_KEYS.EXAM_STATE);
    }

    function saveAdminStateToLocalStorage() {
      try {
        const adminState = {
          currentRole: appState.currentRole,
          currentView: appState.currentView,
          currentSubjectFilter: appState.currentSubjectFilter
        };
        localStorage.setItem(STORAGE_KEYS.ADMIN_STATE, JSON.stringify(adminState));
      } catch (error) {
        console.error('Error saving admin state:', error);
      }
    }

    function loadAdminStateFromLocalStorage() {
      try {
        const savedState = localStorage.getItem(STORAGE_KEYS.ADMIN_STATE);
        if (savedState) {
          const parsed = JSON.parse(savedState);
          appState.currentRole = parsed.currentRole;
          appState.currentView = parsed.currentView;
          appState.currentSubjectFilter = parsed.currentSubjectFilter || 'all';
          return true;
        }
      } catch (error) {
        console.error('Error loading admin state:', error);
      }
      return false;
    }

    function clearAdminStateFromLocalStorage() {
      localStorage.removeItem(STORAGE_KEYS.ADMIN_STATE);
    }

    // ==================== UTILITY FUNCTIONS ====================
    function generateId() {
      return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    function renderAdminView() {
      switch(appState.currentView) {
        case 'admin-menu':
          renderAdminMenu();
          break;
        case 'subject-management':
          renderSubjectManagement();
          break;
        case 'user-management':
          renderUserManagement();
          break;
        case 'bank-soal':
          renderBankSoal();
          break;
        case 'exam-management':
          renderExamManagement();
          break;
        case 'monitoring':
          renderMonitoring();
          break;
        default:
          renderAdminMenu();
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    function showLoading() {
      const loading = document.createElement('div');
      loading.id = 'loading-overlay';
      loading.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      loading.innerHTML = '<div class="loading-spinner"></div>';
      document.body.appendChild(loading);
    }

    function hideLoading() {
      const loading = document.getElementById('loading-overlay');
      if (loading) {
        document.body.removeChild(loading);
      }
    }

    // ==================== SUPABASE DATABASE FUNCTIONS ====================
    
    // Cache untuk optimasi performa
    let cachedSubjects = null;
    let cachedSubjectsTime = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 menit

    async function getSubjects(forceRefresh = false) {
      if (!isSupabaseConfigured) return [];
      
      if (!forceRefresh && cachedSubjects && cachedSubjectsTime && (Date.now() - cachedSubjectsTime < CACHE_DURATION)) {
        return cachedSubjects;
      }
      
      try {
        const { data, error } = await supabase
          .from('subjects')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);
        
        if (error) throw error;
        
        cachedSubjects = data || [];
        cachedSubjectsTime = Date.now();
        
        return cachedSubjects;
      } catch (error) {
        console.error('Error fetching subjects:', error);
        return cachedSubjects || [];
      }
    }
    
    function clearSubjectsCache() {
      cachedSubjects = null;
      cachedSubjectsTime = null;
    }

    async function addSubject(subjectData) {
      if (!isSupabaseConfigured) {
        showToast('Supabase belum dikonfigurasi!', 'error');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('subjects')
          .insert([{
            code: subjectData.code,
            name: subjectData.name,
            description: subjectData.description || ''
          }])
          .select();
        
        if (error) throw error;
        
        clearSubjectsCache();
        
        return data[0];
      } catch (error) {
        console.error('Error adding subject:', error);
        showToast('Gagal menambahkan mata pelajaran: ' + error.message, 'error');
        return null;
      }
    }

    async function deleteSubject(id) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('subjects')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        clearSubjectsCache();
        
        return true;
      } catch (error) {
        console.error('Error deleting subject:', error);
        showToast('Gagal menghapus mata pelajaran: ' + error.message, 'error');
        return false;
      }
    }

    // Cache users
    let cachedUsers = null;
    let cachedUsersTime = null;

    async function getUsers(forceRefresh = false) {
      if (!isSupabaseConfigured) return [];
      
      if (!forceRefresh && cachedUsers && cachedUsersTime && (Date.now() - cachedUsersTime < CACHE_DURATION)) {
        return cachedUsers;
      }
      
      try {
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(500);
        
        if (error) throw error;
        
        cachedUsers = data || [];
        cachedUsersTime = Date.now();
        
        return cachedUsers;
      } catch (error) {
        console.error('Error fetching users:', error);
        return cachedUsers || [];
      }
    }
    
    function clearUsersCache() {
      cachedUsers = null;
      cachedUsersTime = null;
    }

    // NEW: Login user function
    async function loginUser(userId, password) {
      if (!isSupabaseConfigured) {
        showToast('Supabase belum dikonfigurasi!', 'error');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .eq('user_id', userId)
          .eq('password', password)
          .single();
        
        if (error) throw error;
        
        return data;
      } catch (error) {
        console.error('Error logging in:', error);
        return null;
      }
    }

    async function addUser(userData) {
      if (!isSupabaseConfigured) {
        showToast('Supabase belum dikonfigurasi!', 'error');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('users')
          .insert([userData])
          .select();
        
        if (error) throw error;
        
        clearUsersCache();
        
        return data[0];
      } catch (error) {
        console.error('Error adding user:', error);
        showToast('Gagal menambahkan user: ' + error.message, 'error');
        return null;
      }
    }

    async function deleteUser(id) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('users')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        clearUsersCache();
        
        return true;
      } catch (error) {
        console.error('Error deleting user:', error);
        showToast('Gagal menghapus user: ' + error.message, 'error');
        return false;
      }
    }

    // Cache questions
    let cachedQuestions = new Map();
    let cachedQuestionsTime = new Map();

    async function getQuestions(subjectFilter = 'all', forceRefresh = false) {
      if (!isSupabaseConfigured) return [];
      
      const cacheKey = subjectFilter;
      if (!forceRefresh && cachedQuestions.has(cacheKey) && cachedQuestionsTime.has(cacheKey)) {
        const cacheTime = cachedQuestionsTime.get(cacheKey);
        if (Date.now() - cacheTime < CACHE_DURATION) {
          return cachedQuestions.get(cacheKey);
        }
      }
      
      try {
        let query = supabase
          .from('questions')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(1000);
        
        if (subjectFilter !== 'all') {
          query = query.eq('subject', subjectFilter);
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        cachedQuestions.set(cacheKey, data || []);
        cachedQuestionsTime.set(cacheKey, Date.now());
        
        return data || [];
      } catch (error) {
        console.error('Error fetching questions:', error);
        return cachedQuestions.get(cacheKey) || [];
      }
    }
    
    function clearQuestionsCache() {
      cachedQuestions.clear();
      cachedQuestionsTime.clear();
    }

    async function addQuestion(questionData) {
      if (!isSupabaseConfigured) {
        showToast('Supabase belum dikonfigurasi!', 'error');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('questions')
          .insert([questionData])
          .select();
        
        if (error) throw error;
        
        clearQuestionsCache();
        
        return data[0];
      } catch (error) {
        console.error('Error adding question:', error);
        showToast('Gagal menambahkan soal: ' + error.message, 'error');
        return null;
      }
    }

    async function updateQuestion(id, updates) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('questions')
          .update(updates)
          .eq('id', id);
        
        if (error) throw error;
        
        clearQuestionsCache();
        
        return true;
      } catch (error) {
        console.error('Error updating question:', error);
        return false;
      }
    }

    async function deleteQuestion(id) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('questions')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        clearQuestionsCache();
        
        return true;
      } catch (error) {
        console.error('Error deleting question:', error);
        showToast('Gagal menghapus soal: ' + error.message, 'error');
        return false;
      }
    }

    // Cache exams
    let cachedExams = null;
    let cachedExamsTime = null;

    async function getExams(forceRefresh = false) {
      if (!isSupabaseConfigured) return [];
      
      if (!forceRefresh && cachedExams && cachedExamsTime && (Date.now() - cachedExamsTime < CACHE_DURATION)) {
        return cachedExams;
      }
      
      try {
        const { data, error } = await supabase
          .from('exams')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);
        
        if (error) throw error;
        
        cachedExams = data || [];
        cachedExamsTime = Date.now();
        
        return cachedExams;
      } catch (error) {
        console.error('Error fetching exams:', error);
        return cachedExams || [];
      }
    }
    
    function clearExamsCache() {
      cachedExams = null;
      cachedExamsTime = null;
    }

    async function addExam(examData) {
      if (!isSupabaseConfigured) {
        showToast('Supabase belum dikonfigurasi!', 'error');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('exams')
          .insert([examData])
          .select();
        
        if (error) throw error;
        
        clearExamsCache();
        
        return data[0];
      } catch (error) {
        console.error('Error adding exam:', error);
        showToast('Gagal menambahkan exam: ' + error.message, 'error');
        return null;
      }
    }

    async function updateExam(id, updates) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('exams')
          .update(updates)
          .eq('id', id);
        
        if (error) throw error;
        
        clearExamsCache();
        
        return true;
      } catch (error) {
        console.error('Error updating exam:', error);
        return false;
      }
    }

    async function deleteExam(id) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('exams')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        clearExamsCache();
        
        return true;
      } catch (error) {
        console.error('Error deleting exam:', error);
        showToast('Gagal menghapus exam: ' + error.message, 'error');
        return false;
      }
    }

    async function getExamByToken(token) {
      if (!isSupabaseConfigured) return null;
      try {
        const { data, error } = await supabase
          .from('exams')
          .select('*')
          .eq('token', token)
          .single();
        
        if (error) throw error;
        return data;
      } catch (error) {
        console.error('Error fetching exam by token:', error);
        return null;
      }
    }

    // Student Sessions
    async function createStudentSession(sessionData) {
      if (!isSupabaseConfigured) return null;
      
      try {
        const { data, error } = await supabase
          .from('student_sessions')
          .insert([sessionData])
          .select();
        
        if (error) throw error;
        return data[0];
      } catch (error) {
        console.error('Error creating session:', error);
        return null;
      }
    }

    async function updateStudentSession(sessionId, updates) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('student_sessions')
          .update(updates)
          .eq('id', sessionId);
        
        if (error) throw error;
        return true;
      } catch (error) {
        console.error('Error updating session:', error);
        return false;
      }
    }

    // NEW: Get student sessions by student ID
    async function getStudentSessions(studentId) {
      if (!isSupabaseConfigured) return [];
      
      try {
        const { data, error } = await supabase
          .from('student_sessions')
          .select('*')
          .eq('student_id', studentId)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Error fetching student sessions:', error);
        return [];
      }
    }

    // NEW: Get active session for student and exam
    async function getActiveSession(studentId, examToken) {
      if (!isSupabaseConfigured) return null;
      
      try {
        const { data, error } = await supabase
          .from('student_sessions')
          .select('*')
          .eq('student_id', studentId)
          .eq('exam_token', examToken)
          .eq('status', 'active')
          .maybeSingle();
        
        if (error) throw error;
        return data;
      } catch (error) {
        console.error('Error fetching active session:', error);
        return null;
      }
    }

    // Cache sessions
    let cachedSessions = null;
    let cachedSessionsTime = null;
    const SESSION_CACHE_DURATION = 10000; // 10 detik

    async function getActiveSessions(forceRefresh = false) {
      if (!isSupabaseConfigured) return [];
      
      if (!forceRefresh && cachedSessions && cachedSessionsTime && (Date.now() - cachedSessionsTime < SESSION_CACHE_DURATION)) {
        return cachedSessions.filter(s => s.status === 'active');
      }
      
      try {
        const { data, error } = await supabase
          .from('student_sessions')
          .select('*')
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(300);
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Error fetching active sessions:', error);
        return [];
      }
    }

    async function getAllSessions(forceRefresh = false) {
      if (!isSupabaseConfigured) return [];
      
      if (!forceRefresh && cachedSessions && cachedSessionsTime && (Date.now() - cachedSessionsTime < SESSION_CACHE_DURATION)) {
        return cachedSessions;
      }
      
      try {
        const { data, error } = await supabase
          .from('student_sessions')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(300);
        
        if (error) throw error;
        
        cachedSessions = data || [];
        cachedSessionsTime = Date.now();
        
        return cachedSessions;
      } catch (error) {
        console.error('Error fetching all sessions:', error);
        return cachedSessions || [];
      }
    }
    
    function clearSessionsCache() {
      cachedSessions = null;
      cachedSessionsTime = null;
    }

    async function finishSession(sessionId) {
      if (!isSupabaseConfigured) return false;
      
      try {
        const { error } = await supabase
          .from('student_sessions')
          .update({ 
            status: 'finished',
            finished_at: new Date().toISOString()
          })
          .eq('id', sessionId);
        
        if (error) throw error;
        return true;
      } catch (error) {
        console.error('Error finishing session:', error);
        return false;
      }
    }

    // Student Answers
    async function saveAnswer(answerData) {
      if (!isSupabaseConfigured) return null;
      
      try {
        // Check if answer already exists
        const { data: existing, error: fetchError } = await supabase
          .from('student_answers')
          .select('id')
          .eq('session_id', answerData.session_id)
          .eq('question_number', answerData.question_number)
          .maybeSingle();

        if (existing) {
          // Update existing answer
          const { data, error } = await supabase
            .from('student_answers')
            .update({
              answer: answerData.answer,
              is_doubtful: answerData.is_doubtful
            })
            .eq('id', existing.id)
            .select();
          
          if (error) throw error;
          return data[0];
        } else {
          // Insert new answer
          const { data, error } = await supabase
            .from('student_answers')
            .insert([answerData])
            .select();
          
          if (error) throw error;
          return data[0];
        }
      } catch (error) {
        console.error('Error saving answer:', error);
        return null;
      }
    }

    async function getSessionAnswers(sessionId) {
      if (!isSupabaseConfigured) return [];
      try {
        const { data, error } = await supabase
          .from('student_answers')
          .select('*')
          .eq('session_id', sessionId);
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Error fetching answers:', error);
        return [];
      }
    }

    async function getRandomQuestionsBySubject(exam) {
      if (!isSupabaseConfigured) return [];
      try {
        const { data, error } = await supabase
          .from('questions')
          .select('*')
          .eq('subject', exam.subject)
          .limit(1000);
        
        if (error) throw error;
        
        const allQuestions = data || [];
        
        // Check if exam has pg_count and pgk_count (specific type split)
        if (exam.pg_count !== undefined && exam.pgk_count !== undefined) {
          const pgQuestions = allQuestions.filter(q => q.type === 'pg');
          const pgkQuestions = allQuestions.filter(q => q.type === 'pgk');
          
          // Shuffle and take required count
          const shuffledPg = pgQuestions.sort(() => Math.random() - 0.5);
          const shuffledPgk = pgkQuestions.sort(() => Math.random() - 0.5);
          
          const selectedPg = shuffledPg.slice(0, exam.pg_count);
          const selectedPgk = shuffledPgk.slice(0, exam.pgk_count);
          
          // Combine and shuffle again
          const combined = [...selectedPg, ...selectedPgk];
          return combined.sort(() => Math.random() - 0.5);
        }
        // Check if exam has difficulty-based distribution with type split
        else if (exam.pg_easy_count !== undefined) {
          const pgEasyQuestions = allQuestions.filter(q => q.type === 'pg' && q.difficulty === 'easy');
          const pgMediumQuestions = allQuestions.filter(q => q.type === 'pg' && q.difficulty === 'medium');
          const pgHardQuestions = allQuestions.filter(q => q.type === 'pg' && q.difficulty === 'hard');
          const pgkEasyQuestions = allQuestions.filter(q => q.type === 'pgk' && q.difficulty === 'easy');
          const pgkMediumQuestions = allQuestions.filter(q => q.type === 'pgk' && q.difficulty === 'medium');
          const pgkHardQuestions = allQuestions.filter(q => q.type === 'pgk' && q.difficulty === 'hard');
          
          const shuffledPgEasy = pgEasyQuestions.sort(() => Math.random() - 0.5);
          const shuffledPgMedium = pgMediumQuestions.sort(() => Math.random() - 0.5);
          const shuffledPgHard = pgHardQuestions.sort(() => Math.random() - 0.5);
          const shuffledPgkEasy = pgkEasyQuestions.sort(() => Math.random() - 0.5);
          const shuffledPgkMedium = pgkMediumQuestions.sort(() => Math.random() - 0.5);
          const shuffledPgkHard = pgkHardQuestions.sort(() => Math.random() - 0.5);
          
          const selectedPgEasy = shuffledPgEasy.slice(0, exam.pg_easy_count);
          const selectedPgMedium = shuffledPgMedium.slice(0, exam.pg_medium_count);
          const selectedPgHard = shuffledPgHard.slice(0, exam.pg_hard_count);
          const selectedPgkEasy = shuffledPgkEasy.slice(0, exam.pgk_easy_count);
          const selectedPgkMedium = shuffledPgkMedium.slice(0, exam.pgk_medium_count);
          const selectedPgkHard = shuffledPgkHard.slice(0, exam.pgk_hard_count);
          
          const combined = [
            ...selectedPgEasy, 
            ...selectedPgMedium, 
            ...selectedPgHard,
            ...selectedPgkEasy,
            ...selectedPgkMedium,
            ...selectedPgkHard
          ];
          return combined.sort(() => Math.random() - 0.5);
        }
        // Check if exam has difficulty-based distribution (generic)
        else if (exam.easy_count !== undefined && exam.medium_count !== undefined && exam.hard_count !== undefined) {
          const easyQuestions = allQuestions.filter(q => q.difficulty === 'easy');
          const mediumQuestions = allQuestions.filter(q => q.difficulty === 'medium');
          const hardQuestions = allQuestions.filter(q => q.difficulty === 'hard');
          
          const shuffledEasy = easyQuestions.sort(() => Math.random() - 0.5);
          const shuffledMedium = mediumQuestions.sort(() => Math.random() - 0.5);
          const shuffledHard = hardQuestions.sort(() => Math.random() - 0.5);
          
          const selectedEasy = shuffledEasy.slice(0, exam.easy_count);
          const selectedMedium = shuffledMedium.slice(0, exam.medium_count);
          const selectedHard = shuffledHard.slice(0, exam.hard_count);
          
          const combined = [...selectedEasy, ...selectedMedium, ...selectedHard];
          return combined.sort(() => Math.random() - 0.5);
        } else {
          // Default: random selection
          const shuffled = allQuestions.sort(() => Math.random() - 0.5);
          return shuffled.slice(0, Math.min(exam.total_questions, shuffled.length));
        }
      } catch (error) {
        console.error('Error fetching random questions:', error);
        return [];
      }
    }

    // ==================== BROWSER LOCK FUNCTIONS ====================
    
    function setupBrowserLock() {
      if (!appState.currentExam || appState.currentExam.is_open_book) {
        console.log('Open book exam - No browser lock');
        return;
      }

      console.log('üîí Setting up browser lock for closed book exam');

      // Detect tab switch / visibility change
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('blur', handleWindowBlur);

      // Try to enter fullscreen
      requestFullscreen();
    }

    function removeBrowserLock() {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('blur', handleWindowBlur);
      exitFullscreen();
    }

    function handleVisibilityChange() {
      if (document.hidden) {
        handleViolation('Anda meninggalkan tab ujian!');
      }
    }

    function handleWindowBlur() {
      if (!document.hidden && appState.currentExam && !appState.currentExam.is_open_book) {
        handleViolation('Jangan pindah ke aplikasi lain!');
      }
    }

    function handleViolation(message) {
      appState.violationCount++;
      saveStateToLocalStorage();

      showViolationWarning(message, appState.violationCount);

      // Update violation count to server
      if (appState.examSessionId) {
        updateStudentSession(appState.examSessionId, {
          violation_count: appState.violationCount
        });
      }

      // Auto-submit after 3 violations
      if (appState.violationCount >= 3) {
        showToast('Terlalu banyak pelanggaran! Ujian diselesaikan otomatis.', 'error');
        setTimeout(() => {
          finishExam();
        }, 2000);
      }
    }

    function showViolationWarning(message, count) {
      const warning = document.createElement('div');
      warning.className = 'warning-overlay';
      warning.innerHTML = `
        <div class="bg-white rounded-2xl p-12 max-w-md text-center shadow-2xl">
          <svg class="w-24 h-24 mx-auto text-red-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
          <h2 class="text-3xl font-bold text-red-600 mb-4">‚ö†Ô∏è PERINGATAN!</h2>
          <p class="text-xl font-semibold text-gray-900 mb-2">${message}</p>
          <p class="text-lg text-gray-700 mb-6">Pelanggaran ke-${count} dari 3</p>
          <p class="text-md text-gray-600 mb-8">Setelah 3 pelanggaran, ujian akan diselesaikan otomatis!</p>
          <button onclick="closeViolationWarning()" class="px-8 py-4 bg-red-600 text-white rounded-lg font-bold text-lg hover:bg-red-700 transition">
            Saya Mengerti, Kembali ke Ujian
          </button>
        </div>
      `;
      document.body.appendChild(warning);
    }

    function closeViolationWarning() {
      const warning = document.querySelector('.warning-overlay');
      if (warning) {
        document.body.removeChild(warning);
        // Try to refocus on exam
        window.focus();
        requestFullscreen();
      }
    }

    function requestFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen().catch(err => {
          console.log('Fullscreen request failed:', err);
        });
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen().catch(err => console.log('Exit fullscreen failed:', err));
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }

    // ==================== STUDENT FUNCTIONS ====================
    
    // NEW: Student Login
    async function handleStudentLogin(event) {
      event.preventDefault();
      
      const userId = document.getElementById('studentUserId').value.trim();
      const password = document.getElementById('studentPassword').value.trim();

      if (!userId || !password) {
        showToast('NISN dan Password wajib diisi!', 'error');
        return;
      }

      showLoading();
      const user = await loginUser(userId, password);
      hideLoading();

      if (user) {
        if (user.role !== 'student') {
          showToast('Akun ini bukan akun siswa!', 'error');
          return;
        }

        appState.loggedUser = user;
        appState.studentId = user.user_id;
        appState.studentName = user.name;
        appState.studentClass = user.class;
        appState.currentRole = 'student';

        saveLoggedUser(user);
        showToast(`Selamat datang, ${user.name}!`, 'success');
        renderStudentDashboard();
      } else {
        showToast('NISN atau Password salah!', 'error');
      }
    }

    // NEW: Render Student Dashboard
    async function renderStudentDashboard() {
      showLoading();
      
      // Get all sessions for this student
      const sessions = await getStudentSessions(appState.studentId);
      
      // Get all available exams
      const allExams = await getExams();
      
      hideLoading();

      // Categorize sessions
      const activeSessions = sessions.filter(s => s.status === 'active');
      const finishedSessions = sessions.filter(s => s.status === 'finished');
      
      // Find available exams (not yet taken or not finished)
      const takenExamTokens = sessions.map(s => s.exam_token);
      const availableExams = allExams.filter(exam => !takenExamTokens.includes(exam.token));

      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <div>
                <h1 class="text-2xl font-bold text-gray-900">Dashboard Siswa</h1>
                <p class="text-sm text-gray-600">${appState.studentName} - ${appState.studentClass}</p>
              </div>
              <button onclick="studentLogout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Logout
              </button>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto p-8">
            <!-- Active Exams -->
            ${activeSessions.length > 0 ? `
              <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">üî• Ujian Sedang Dikerjakan</h3>
                <div class="grid md:grid-cols-2 gap-4">
                  ${activeSessions.map(session => `
                    <div class="border-2 border-orange-500 rounded-lg p-6 bg-orange-50">
                      <h4 class="text-xl font-bold text-gray-900 mb-2">${session.exam_title}</h4>
                      <div class="space-y-2 text-sm text-gray-700 mb-4">
                        <p>üìù Soal Terjawab: ${session.answered_count} / ${session.total_questions}</p>
                        <p>‚è±Ô∏è Sisa Waktu: ${formatTime(session.remaining_seconds)}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                          <div class="bg-orange-500 h-2 rounded-full" style="width: ${Math.round((session.answered_count / session.total_questions) * 100)}%"></div>
                        </div>
                      </div>
                      <button onclick="resumeExam('${session.exam_token}')" class="w-full px-6 py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700 transition">
                        ‚ñ∂Ô∏è Lanjutkan Ujian
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Available Exams -->
            ${availableExams.length > 0 ? `
              <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">üìö Ujian Tersedia</h3>
                <div class="grid md:grid-cols-2 gap-4">
                  ${availableExams.map(exam => `
                    <div class="border-2 border-green-500 rounded-lg p-6 bg-green-50">
                      <h4 class="text-xl font-bold text-gray-900 mb-2">${exam.title}</h4>
                      <div class="space-y-2 text-sm text-gray-700 mb-4">
                        <p>üìñ Mata Pelajaran: ${exam.subject}</p>
                        <p>üìù Jumlah Soal: ${exam.total_questions}</p>
                        <p>‚è±Ô∏è Durasi: ${exam.duration} menit</p>
                        <p>üîñ Token: <span class="font-mono font-bold text-green-700">${exam.token}</span></p>
                        <p class="flex items-center gap-2">
                          ${exam.is_open_book ? 
                            '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">üìñ Open Book</span>' : 
                            '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">üîí Closed Book</span>'}
                        </p>
                      </div>
                      <button onclick="startNewExam('${exam.token}')" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                        üöÄ Mulai Ujian
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Finished Exams -->
            ${finishedSessions.length > 0 ? `
              <div class="bg-white rounded-xl shadow-xl p-8">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">‚úÖ Riwayat Ujian</h3>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Ujian</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Tanggal</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Nilai</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Status</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      ${finishedSessions.map(session => `
                        <tr class="hover:bg-gray-50">
                          <td class="px-6 py-4 text-gray-900">${session.exam_title}</td>
                          <td class="px-6 py-4 text-gray-600">${new Date(session.finished_at).toLocaleString('id-ID')}</td>
                          <td class="px-6 py-4 text-center">
                            <span class="text-2xl font-bold ${session.score >= 75 ? 'text-green-600' : session.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                              ${session.score || '-'}
                            </span>
                          </td>
                          <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                              Selesai
                            </span>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}

            ${activeSessions.length === 0 && availableExams.length === 0 && finishedSessions.length === 0 ? `
              <div class="bg-white rounded-xl shadow-xl p-12 text-center">
                <svg class="w-24 h-24 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">Belum Ada Ujian</h3>
                <p class="text-gray-500">Saat ini belum ada ujian yang tersedia untuk Anda.</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function studentLogout() {
      clearLoggedUser();
      clearStateFromLocalStorage();
      appState.loggedUser = null;
      appState.currentRole = null;
      appState.studentId = null;
      appState.studentName = '';
      appState.studentClass = '';
      renderRoleSelection();
    }

    // NEW: Resume exam from server
    async function resumeExam(examToken) {
      showLoading();

      // Get exam data
      const exam = await getExamByToken(examToken);
      if (!exam) {
        hideLoading();
        showToast('Token ujian tidak valid!', 'error');
        return;
      }

      // Get active session
      const session = await getActiveSession(appState.studentId, examToken);
      if (!session) {
        hideLoading();
        showToast('Sesi ujian tidak ditemukan!', 'error');
        return;
      }

      // Parse questions from session
      const questions = JSON.parse(session.questions_data);

      // Get saved answers
      const savedAnswers = await getSessionAnswers(session.id);

      // Restore state
      appState.examSessionId = session.id;
      appState.examTitle = exam.title;
      appState.examSubject = exam.subject;
      appState.currentView = 'student-exam';
      appState.remainingSeconds = session.remaining_seconds;
      appState.totalQuestions = questions.length;
      appState.examQuestions = questions;
      appState.currentExamToken = examToken;
      appState.currentExam = exam;
      appState.violationCount = session.violation_count || 0;

      // Restore answers
      appState.answers.clear();
      savedAnswers.forEach(ans => {
        appState.answers.set(ans.question_number, {
          answer: ans.answer,
          isDoubtful: ans.is_doubtful
        });
      });

      // Find last answered question or start from beginning
      let lastAnsweredIndex = 0;
      for (let i = questions.length - 1; i >= 0; i--) {
        const ans = appState.answers.get(i + 1);
        if (ans && ans.answer) {
          lastAnsweredIndex = i;
          break;
        }
      }
      appState.currentQuestionIndex = lastAnsweredIndex;

      hideLoading();

      showToast('Melanjutkan ujian...', 'success');
      saveStateToLocalStorage();
      startTimer();
      setupBrowserLock();
      renderStudentInterface();
    }

    // NEW: Start new exam
    async function startNewExam(examToken) {
      showLoading();
      
      const exam = await getExamByToken(examToken);
      
      if (!exam) {
        hideLoading();
        showToast('Token ujian tidak valid!', 'error');
        return;
      }

      // Check if there's already an active session
      const existingSession = await getActiveSession(appState.studentId, examToken);
      if (existingSession) {
        hideLoading();
        showToast('Anda sudah memiliki sesi aktif untuk ujian ini!', 'warning');
        await resumeExam(examToken);
        return;
      }

      // Generate questions
      const questions = await getRandomQuestionsBySubject(exam);
      
      if (questions.length === 0) {
        hideLoading();
        showToast(`Belum ada soal tersedia untuk mata pelajaran ${exam.subject}!`, 'error');
        return;
      }

      if (questions.length < exam.total_questions) {
        hideLoading();
        showToast(`Soal tidak cukup! Hanya tersedia ${questions.length} soal untuk ${exam.subject}`, 'error');
        return;
      }

      // Create session
      const session = await createStudentSession({
        student_id: appState.studentId,
        student_name: appState.studentName,
        student_class: appState.studentClass,
        exam_token: examToken,
        exam_title: exam.title,
        total_questions: questions.length,
        answered_count: 0,
        remaining_seconds: exam.duration * 60,
        status: 'active',
        questions_data: JSON.stringify(questions),
        violation_count: 0
      });

      hideLoading();

      if (session) {
        appState.examSessionId = session.id;
        appState.examTitle = exam.title;
        appState.examSubject = exam.subject;
        appState.currentView = 'student-exam';
        appState.remainingSeconds = exam.duration * 60;
        appState.answers.clear();
        appState.currentQuestionIndex = 0;
        appState.totalQuestions = questions.length;
        appState.examQuestions = questions;
        appState.currentExamToken = examToken;
        appState.currentExam = exam;
        appState.violationCount = 0;

        showToast(`Ujian ${exam.title} dimulai!`, 'success');
        
        saveStateToLocalStorage();
        
        startTimer();
        setupBrowserLock();
        renderStudentInterface();
      }
    }

    // Auto-check untuk session yang waktu habis di monitoring
    async function autoFinishExpiredSessions() {
      if (!isSupabaseConfigured) return;
      
      try {
        const { data: activeSessions, error } = await supabase
          .from('student_sessions')
          .select('*')
          .eq('status', 'active')
          .lte('remaining_seconds', 0);
        
        if (error) throw error;
        
        if (activeSessions && activeSessions.length > 0) {
          for (const session of activeSessions) {
            await finishSession(session.id);
          }
        }
      } catch (error) {
        console.error('Error auto-finishing expired sessions:', error);
      }
    }

    function startTimer() {
      if (appState.timerInterval) clearInterval(appState.timerInterval);
      
      appState.timerInterval = setInterval(async () => {
        appState.remainingSeconds--;
        
        if (appState.remainingSeconds <= 0) {
          clearInterval(appState.timerInterval);
          showToast('Waktu habis! Ujian diselesaikan otomatis', 'warning');
          await finishExam();
        } else {
          updateTimerDisplay();
          saveStateToLocalStorage();
          
          // Update session setiap 30 detik
          if (appState.remainingSeconds % 30 === 0) {
            const answeredCount = Array.from(appState.answers.values()).filter(a => a.answer).length;
            await updateStudentSession(appState.examSessionId, {
              answered_count: answeredCount,
              remaining_seconds: appState.remainingSeconds
            });
          }
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const hours = Math.floor(appState.remainingSeconds / 3600);
      const minutes = Math.floor((appState.remainingSeconds % 3600) / 60);
      const seconds = appState.remainingSeconds % 60;
      
      const timerEl = document.getElementById('timer');
      if (timerEl) {
        timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        if (appState.remainingSeconds <= 300) {
          timerEl.classList.add('timer-warning');
        }
      }
    }

    async function selectAnswer(answer) {
      const questionNumber = appState.currentQuestionIndex + 1;
      
      appState.answers.set(questionNumber, {
        answer: answer,
        isDoubtful: false
      });

      // Save to database
      await saveAnswer({
        session_id: appState.examSessionId,
        question_number: questionNumber,
        answer: answer,
        is_doubtful: false
      });

      // Update answered count
      const answeredCount = Array.from(appState.answers.values()).filter(a => a.answer).length;
      await updateStudentSession(appState.examSessionId, {
        answered_count: answeredCount
      });

      saveStateToLocalStorage();
      renderQuestionContent();
      renderQuestionNavigator();
    }

    async function togglePGKAnswer(option) {
      const questionNumber = appState.currentQuestionIndex + 1;
      const current = appState.answers.get(questionNumber);
      
      let selectedAnswers = [];
      if (current && current.answer) {
        selectedAnswers = current.answer.split(',').filter(a => a);
      }
      
      const index = selectedAnswers.indexOf(option);
      if (index > -1) {
        selectedAnswers.splice(index, 1);
      } else {
        selectedAnswers.push(option);
      }
      
      selectedAnswers.sort();
      const answerString = selectedAnswers.join(',');
      
      appState.answers.set(questionNumber, {
        answer: answerString,
        isDoubtful: false
      });

      // Save to database
      await saveAnswer({
        session_id: appState.examSessionId,
        question_number: questionNumber,
        answer: answerString,
        is_doubtful: false
      });

      // Update answered count
      const answeredCount = Array.from(appState.answers.values()).filter(a => a.answer).length;
      await updateStudentSession(appState.examSessionId, {
        answered_count: answeredCount
      });

      saveStateToLocalStorage();
      renderQuestionContent();
      renderQuestionNavigator();
    }

    async function markAsDoubtful() {
      const questionNumber = appState.currentQuestionIndex + 1;
      const current = appState.answers.get(questionNumber);
      
      if (current) {
        current.isDoubtful = true;
        appState.answers.set(questionNumber, current);
        await saveAnswer({
          session_id: appState.examSessionId,
          question_number: questionNumber,
          answer: current.answer,
          is_doubtful: true
        });
      } else {
        appState.answers.set(questionNumber, {
          answer: '',
          isDoubtful: true
        });
        await saveAnswer({
          session_id: appState.examSessionId,
          question_number: questionNumber,
          answer: '',
          is_doubtful: true
        });
      }

      saveStateToLocalStorage();
      renderQuestionNavigator();
      showToast('Soal ditandai ragu-ragu', 'info');
    }

    function goToQuestion(index) {
      appState.currentQuestionIndex = index;
      renderQuestionContent();
      renderQuestionNavigator();
    }

    function previousQuestion() {
      if (appState.currentQuestionIndex > 0) {
        appState.currentQuestionIndex--;
        renderQuestionContent();
        renderQuestionNavigator();
      }
    }

    function nextQuestion() {
      if (appState.currentQuestionIndex < appState.totalQuestions - 1) {
        appState.currentQuestionIndex++;
        renderQuestionContent();
        renderQuestionNavigator();
      }
    }

    function showFinishConfirmation() {
      const answered = Array.from(appState.answers.values()).filter(a => a.answer).length;
      const unanswered = appState.totalQuestions - answered;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-2xl">
          <h3 class="text-2xl font-bold text-gray-900 mb-4">Konfirmasi Selesai Ujian</h3>
          <div class="mb-6 space-y-2">
            <p class="text-gray-700">Soal dijawab: <span class="font-semibold text-green-600">${answered}</span></p>
            <p class="text-gray-700">Belum dijawab: <span class="font-semibold text-red-600">${unanswered}</span></p>
            ${unanswered > 0 ? '<p class="text-sm text-orange-600 mt-4">‚ö†Ô∏è Masih ada soal yang belum dijawab!</p>' : ''}
          </div>
          <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menyelesaikan ujian?</p>
          <div class="flex gap-3">
            <button id="cancelFinish" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition">
              Batal
            </button>
            <button id="confirmFinish" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition">
              Ya, Selesai
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('cancelFinish').onclick = () => {
        document.body.removeChild(modal);
      };

      document.getElementById('confirmFinish').onclick = async () => {
        document.body.removeChild(modal);
        await finishExam();
      };
    }

    async function finishExam() {
      if (appState.timerInterval) {
        clearInterval(appState.timerInterval);
      }

      // Remove browser lock
      removeBrowserLock();

      // Hitung nilai
      let correctCount = 0;
      let totalPoints = 0;
      let earnedPoints = 0;

      appState.examQuestions.forEach((question, index) => {
        const questionNumber = index + 1;
        const studentAnswer = appState.answers.get(questionNumber);
        
        if (studentAnswer && studentAnswer.answer) {
          totalPoints += question.points;
          
          if (question.type === 'pg') {
            if (studentAnswer.answer === question.correct_answer) {
              correctCount++;
              earnedPoints += question.points;
            }
          } else if (question.type === 'pgk') {
            const correctAnswers = question.correct_answers.split(',').sort().join(',');
            const studentAnswers = studentAnswer.answer.split(',').sort().join(',');
            
            if (studentAnswers === correctAnswers) {
              correctCount++;
              earnedPoints += question.points;
            }
          }
        } else {
          totalPoints += question.points;
        }
      });

      const score = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;

      // Update session dengan nilai
      await updateStudentSession(appState.examSessionId, {
        status: 'finished',
        finished_at: new Date().toISOString(),
        score: score,
        correct_count: correctCount,
        total_points: totalPoints,
        earned_points: earnedPoints
      });
      
      clearStateFromLocalStorage();
      showResultPage(appState.answers.size, appState.totalQuestions, score, correctCount);
    }

    function showResultPage(answered, total, score, correctCount) {
      const app = document.getElementById('app');
      
      let gradeColor = 'text-red-600';
      let gradeBg = 'bg-red-50';
      let gradeText = 'Perlu Belajar Lebih Giat';
      
      if (score >= 90) {
        gradeColor = 'text-green-600';
        gradeBg = 'bg-green-50';
        gradeText = 'Luar Biasa! üèÜ';
      } else if (score >= 80) {
        gradeColor = 'text-blue-600';
        gradeBg = 'bg-blue-50';
        gradeText = 'Sangat Baik! üåü';
      } else if (score >= 70) {
        gradeColor = 'text-yellow-600';
        gradeBg = 'bg-yellow-50';
        gradeText = 'Baik! üëç';
      } else if (score >= 60) {
        gradeColor = 'text-orange-600';
        gradeBg = 'bg-orange-50';
        gradeText = 'Cukup';
      }
      
      app.innerHTML = `
        <div class="min-h-full flex items-center justify-center p-8" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);">
          <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-3xl w-full text-center fade-in">
            <div class="mb-6">
              <svg class="w-24 h-24 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h2 class="text-4xl font-bold mb-2 text-gray-900">Ujian Selesai!</h2>
            <p class="text-xl text-gray-600 mb-2">Terima kasih ${appState.studentName}</p>
            <p class="text-md text-gray-500 mb-8">${appState.examTitle}</p>
            
            <div class="${gradeBg} rounded-xl p-6 mb-6">
              <p class="text-sm text-gray-600 mb-2">Nilai Akhir</p>
              <p class="text-6xl font-bold ${gradeColor} mb-2">${score}</p>
              <p class="text-lg font-semibold ${gradeColor}">${gradeText}</p>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-6 mb-8">
              <div class="grid grid-cols-4 gap-4 mb-4">
                <div class="text-center">
                  <p class="text-gray-500 text-sm mb-1">Benar</p>
                  <p class="text-3xl font-bold text-green-600">${correctCount}</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-500 text-sm mb-1">Salah</p>
                  <p class="text-3xl font-bold text-red-600">${answered - correctCount}</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-500 text-sm mb-1">Tidak Dijawab</p>
                  <p class="text-3xl font-bold text-gray-600">${total - answered}</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-500 text-sm mb-1">Total Soal</p>
                  <p class="text-3xl font-bold text-blue-600">${total}</p>
                </div>
              </div>
              <div class="mt-4">
                <div class="w-full bg-gray-200 rounded-full h-4">
                  <div class="bg-green-500 h-4 rounded-full progress-bar" style="width: ${score}%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">Persentase Nilai: ${score}%</p>
              </div>
            </div>

            <button onclick="backToDashboard()" class="px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
              Kembali ke Dashboard
            </button>
          </div>
        </div>
      `;
    }

    function backToDashboard() {
      renderStudentDashboard();
    }

    // ==================== ADMIN FUNCTIONS ====================
    
    async function handleAddSubject(event) {
      event.preventDefault();
      
      const code = document.getElementById('subjectCode').value.trim().toUpperCase();
      const name = document.getElementById('subjectName').value.trim();
      const description = document.getElementById('subjectDescription').value.trim();

      if (!code || !name) {
        showToast('Kode dan Nama wajib diisi!', 'error');
        return;
      }

      showLoading();
      const result = await addSubject({ code, name, description });
      hideLoading();

      if (result) {
        showToast('Mata pelajaran berhasil ditambahkan!', 'success');
        document.getElementById('subjectForm').reset();
        renderSubjectManagement();
      }
    }

    async function handleDeleteSubject(id) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-2xl">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Konfirmasi Hapus</h3>
          <p class="text-gray-600 mb-6">Yakin ingin menghapus mata pelajaran ini?</p>
          <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
              Batal
            </button>
            <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
              Hapus
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelDelete').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('confirmDelete').onclick = async () => {
        document.body.removeChild(modal);
        showLoading();
        const success = await deleteSubject(id);
        hideLoading();

        if (success) {
          showToast('Mata pelajaran berhasil dihapus!', 'success');
          renderSubjectManagement();
        }
      };
    }

    async function handleAddUser(event) {
      event.preventDefault();
      
      const userId = document.getElementById('userId').value.trim();
      const userName = document.getElementById('userName').value.trim();
      const userRole = document.getElementById('userRole').value;
      const userPassword = document.getElementById('userPassword').value;
      const userClass = document.getElementById('userClass') ? document.getElementById('userClass').value.trim() : '';

      if (!userId || !userName || !userPassword) {
        showToast('Semua field wajib diisi!', 'error');
        return;
      }

      showLoading();
      const result = await addUser({
        user_id: userId,
        name: userName,
        role: userRole,
        password: userPassword,
        class: userClass
      });
      hideLoading();

      if (result) {
        showToast('User berhasil ditambahkan!', 'success');
        document.getElementById('userForm').reset();
        renderUserManagement();
      }
    }

    async function handleDeleteUser(id) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-2xl">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Konfirmasi Hapus</h3>
          <p class="text-gray-600 mb-6">Yakin ingin menghapus user ini?</p>
          <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
              Batal
            </button>
            <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
              Hapus
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelDelete').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('confirmDelete').onclick = async () => {
        document.body.removeChild(modal);
        showLoading();
        const success = await deleteUser(id);
        hideLoading();

        if (success) {
          showToast('User berhasil dihapus!', 'success');
          renderUserManagement();
        }
      };
    }

    function downloadUserTemplate() {
      const wb = XLSX.utils.book_new();
      
      const wsData = [
        ['TEMPLATE IMPORT USER CBT SYSTEM'],
        ['Petunjuk Pengisian:'],
        ['1. Isi data mulai dari baris ke-5'],
        ['2. Jangan ubah atau hapus header kolom'],
        ['3. Role yang valid: student, teacher, admin'],
        [],
        ['NISN/ID', 'Nama Lengkap', 'Kelas', 'Role', 'Password'],
        ['1234567890', 'Ahmad Fauzi', 'X-TAV', 'student', 'pass123'],
        ['0987654321', 'Siti Nurhaliza', 'XI-TKJ', 'student', 'pass123']
      ];

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      ws['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, ws, 'Template User');
      XLSX.writeFile(wb, 'Template_User_CBT.xlsx');
      showToast('Template Excel berhasil diunduh!', 'success');
    }

    async function handleExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          // Find header row
          let headerRowIndex = -1;
          for (let i = 0; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row[0] && (row[0].toString().toLowerCase().includes('nisn') || row[0].toString().toLowerCase().includes('id'))) {
              headerRowIndex = i;
              break;
            }
          }

          if (headerRowIndex === -1) {
            showToast('Format Excel salah! Header tidak ditemukan.', 'error');
            return;
          }

          showLoading();
          let imported = 0;
          let failed = 0;
          let skipped = 0;

          const usersToInsert = [];
          
          for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!row || row.length < 4) {
              skipped++;
              continue;
            }

            const [userId, name, userClass, role, password] = row;
            
            if (!userId || !name) {
              skipped++;
              continue;
            }

            usersToInsert.push({
              user_id: String(userId),
              name: String(name),
              class: String(userClass || ''),
              role: String(role || 'student').toLowerCase(),
              password: String(password || 'default123')
            });
          }

          if (usersToInsert.length > 0) {
            try {
              const { data, error } = await supabase
                .from('users')
                .insert(usersToInsert)
                .select();
              
              if (error) {
                // Fallback to individual inserts
                for (const userData of usersToInsert) {
                  const result = await addUser(userData);
                  if (result) imported++;
                  else failed++;
                }
              } else {
                imported = data.length;
                clearUsersCache();
              }
            } catch (error) {
              console.error('Batch insert error:', error);
              // Fallback to individual inserts
              for (const userData of usersToInsert) {
                const result = await addUser(userData);
                if (result) imported++;
                else failed++;
              }
            }
          }

          hideLoading();
          showToast(`Import selesai! Berhasil: ${imported}, Gagal: ${failed}, Dilewati: ${skipped}`, 'success');
          renderUserManagement();
        } catch (error) {
          hideLoading();
          console.error('Error reading Excel:', error);
          showToast('Gagal membaca file Excel', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    async function handleAddQuestion(event) {
      event.preventDefault();
      
      const type = document.getElementById('questionType').value;
      const subject = document.getElementById('questionSubject').value;
      const text = document.getElementById('questionText').value.trim();
      const optionA = document.getElementById('optionA').value.trim();
      const optionB = document.getElementById('optionB').value.trim();
      const optionC = document.getElementById('optionC').value.trim();
      const optionD = document.getElementById('optionD').value.trim();
      const optionE = document.getElementById('optionE').value.trim();
      const difficulty = document.getElementById('difficulty').value;
      const points = parseInt(document.getElementById('points').value);

      if (!text || !optionA || !optionB || !optionC || !optionD || !optionE || !subject) {
        showToast('Semua field wajib diisi!', 'error');
        return;
      }

      let correctAnswer = '';
      let correctAnswersArray = '';

      if (type === 'pg') {
        correctAnswer = document.getElementById('correctAnswer').value;
      } else {
        const checkedAnswers = [];
        if (document.getElementById('ansA').checked) checkedAnswers.push('A');
        if (document.getElementById('ansB').checked) checkedAnswers.push('B');
        if (document.getElementById('ansC').checked) checkedAnswers.push('C');
        if (document.getElementById('ansD').checked) checkedAnswers.push('D');
        if (document.getElementById('ansE').checked) checkedAnswers.push('E');
        
        if (checkedAnswers.length === 0) {
          showToast('Pilih minimal 1 jawaban benar untuk PGK!', 'error');
          return;
        }
        
        correctAnswersArray = checkedAnswers.join(',');
      }

      showLoading();
      const result = await addQuestion({
        type,
        subject,
        question_text: text,
        option_a: optionA,
        option_b: optionB,
        option_c: optionC,
        option_d: optionD,
        option_e: optionE,
        correct_answer: correctAnswer,
        correct_answers: correctAnswersArray,
        difficulty,
        points
      });
      hideLoading();

      if (result) {
        showToast('Soal berhasil ditambahkan!', 'success');
        document.getElementById('questionForm').reset();
        toggleAnswerType();
        renderBankSoal();
      }
    }

    async function handleDeleteQuestion(id) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-2xl">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Konfirmasi Hapus</h3>
          <p class="text-gray-600 mb-6">Yakin ingin menghapus soal ini?</p>
          <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
              Batal
            </button>
            <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
              Hapus
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelDelete').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('confirmDelete').onclick = async () => {
        document.body.removeChild(modal);
        showLoading();
        const success = await deleteQuestion(id);
        hideLoading();

        if (success) {
          showToast('Soal berhasil dihapus!', 'success');
          renderBankSoal();
        }
      };
    }

    function toggleAnswerType() {
      const type = document.getElementById('questionType').value;
      const pgSection = document.getElementById('pgAnswerSection');
      const pgkSection = document.getElementById('pgkAnswerSection');
      
      if (type === 'pg') {
        pgSection.style.display = 'block';
        pgkSection.style.display = 'none';
      } else {
        pgSection.style.display = 'none';
        pgkSection.style.display = 'block';
      }
    }

    async function filterBySubject(subject) {
      appState.currentSubjectFilter = subject;
      saveAdminStateToLocalStorage();
      await renderBankSoal();
    }

    function toggleBulkEditMode() {
      appState.bulkEditMode = !appState.bulkEditMode;
      appState.selectedQuestions.clear();
      renderBankSoal();
    }

    function toggleQuestionSelection(id) {
      if (appState.selectedQuestions.has(id)) {
        appState.selectedQuestions.delete(id);
      } else {
        appState.selectedQuestions.add(id);
      }
      renderBankSoal();
    }

    async function selectAllQuestions() {
      const questions = await getQuestions(appState.currentSubjectFilter);
      
      if (appState.selectedQuestions.size === questions.length) {
        appState.selectedQuestions.clear();
      } else {
        questions.forEach(q => appState.selectedQuestions.add(q.id));
      }
      renderBankSoal();
    }

    async function showBulkEditModal() {
      if (appState.selectedQuestions.size === 0) {
        showToast('Pilih minimal 1 soal untuk diedit', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 shadow-2xl">
          <h3 class="text-2xl font-bold text-gray-900 mb-4">ÔøΩÔøΩÔøΩÔ∏è Edit Massal (${appState.selectedQuestions.size} Soal)</h3>
          
          <form id="bulkEditForm" class="space-y-4">
            <div class="border-2 border-gray-200 rounded-lg p-4">
              <label class="flex items-center mb-3 cursor-pointer">
                <input type="checkbox" id="changeDifficulty" class="mr-3 w-5 h-5">
                <span class="font-semibold text-gray-900">Ubah Kesulitan</span>
              </label>
              <select id="bulkDifficulty" disabled class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                <option value="easy">Mudah</option>
                <option value="medium">Sedang</option>
                <option value="hard">Sulit</option>
              </select>
            </div>

            <div class="border-2 border-gray-200 rounded-lg p-4">
              <label class="flex items-center mb-3 cursor-pointer">
                <input type="checkbox" id="changePoints" class="mr-3 w-5 h-5">
                <span class="font-semibold text-gray-900">Ubah Poin Soal</span>
              </label>
              <input type="number" id="bulkPoints" disabled min="0" value="1" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" id="cancelBulk" class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition">
                Batal
              </button>
              <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                üíæ Terapkan
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Enable/disable inputs based on checkboxes
      ['changeDifficulty', 'changePoints'].forEach(checkboxId => {
        const checkbox = document.getElementById(checkboxId);
        const inputId = checkboxId.replace('change', 'bulk');
        const input = document.getElementById(inputId);
        
        checkbox.onchange = () => {
          input.disabled = !checkbox.checked;
        };
      });

      document.getElementById('cancelBulk').onclick = () => {
        document.body.removeChild(modal);
      };

      document.getElementById('bulkEditForm').onsubmit = async (e) => {
        e.preventDefault();

        const changeDifficulty = document.getElementById('changeDifficulty').checked;
        const changePoints = document.getElementById('changePoints').checked;

        if (!changeDifficulty && !changePoints) {
          showToast('Pilih minimal 1 field untuk diubah', 'warning');
          return;
        }

        const updates = {};
        if (changeDifficulty) {
          updates.difficulty = document.getElementById('bulkDifficulty').value;
        }
        if (changePoints) {
          updates.points = parseInt(document.getElementById('bulkPoints').value);
        }

        showLoading();
        let updated = 0;
        let failed = 0;

        for (const id of appState.selectedQuestions) {
          const success = await updateQuestion(id, updates);
          if (success) {
            updated++;
          } else {
            failed++;
          }
        }

        hideLoading();
        document.body.removeChild(modal);
        appState.selectedQuestions.clear();
        appState.bulkEditMode = false;
        
        showToast(`Edit massal selesai! Berhasil: ${updated}, Gagal: ${failed}`, 'success');
        renderBankSoal();
      };
    }

    function downloadWordTemplate() {
      const wb = XLSX.utils.book_new();
      
      const wsData = [
        ['TEMPLATE IMPORT SOAL CBT SYSTEM'],
        [''],
        ['Petunjuk Pengisian:'],
        ['1. Isi data mulai dari baris ke-8 (setelah header)'],
        ['2. Tipe soal: pg (Pilihan Ganda) atau pgk (PG Kompleks)'],
        ['3. Jawaban PG: satu huruf (A/B/C/D/E). Contoh: C'],
        ['4. Jawaban PGK: beberapa huruf dipisah koma (A,B,C). Contoh: A,C,E'],
        ['5. Kesulitan: easy, medium, atau hard'],
        ['6. Kolom Mata Pelajaran akan diabaikan saat import (pilih di modal)'],
        [''],
        ['Tipe', 'Mata Pelajaran', 'Soal', 'Pilihan A', 'Pilihan B', 'Pilihan C', 'Pilihan D', 'Pilihan E', 'Jawaban Benar', 'Kesulitan', 'Poin'],
        ['pg', '(diabaikan)', 'Berapakah hasil dari 15 + 25?', '30', '35', '40', '45', '50', 'C', 'easy', '1'],
        ['pgk', '(diabaikan)', 'Pilih bilangan genap berikut:', '2', '3', '4', '5', '6', 'A,C,E', 'medium', '2'],
        ['pg', '(diabaikan)', 'Ibu kota Indonesia adalah...', 'Jakarta', 'Bandung', 'Surabaya', 'Medan', 'Semarang', 'A', 'easy', '1']
      ];

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      ws['!cols'] = [
        { wch: 8 },
        { wch: 15 },
        { wch: 50 },
        { wch: 20 },
        { wch: 20 },
        { wch: 20 },
        { wch: 20 },
        { wch: 20 },
        { wch: 15 },
        { wch: 12 },
        { wch: 8 }
      ];
      
      XLSX.utils.book_append_sheet(wb, ws, 'Template Soal');
      XLSX.writeFile(wb, 'Template_Soal_CBT.xlsx');
      showToast('Template Excel berhasil diunduh!', 'success');
    }

    async function showImportExcelModal() {
      showLoading();
      const subjects = await getSubjects();
      hideLoading();

      if (subjects.length === 0) {
        showToast('Tambahkan mata pelajaran terlebih dahulu!', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 shadow-2xl">
          <h3 class="text-2xl font-bold text-gray-900 mb-6">üì§ Import Soal dari Excel</h3>
          
          <form id="importExcelForm" class="space-y-4">
            <div>
              <label for="importSubject" class="block text-sm font-medium text-gray-700 mb-2">Pilih Mata Pelajaran *</label>
              <select id="importSubject" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                <option value="">-- Pilih Mata Pelajaran --</option>
                ${subjects.map(s => `<option value="${s.code}">${s.code} - ${s.name}</option>`).join('')}
              </select>
            </div>

            <div>
              <label for="excelFileInput" class="block text-sm font-medium text-gray-700 mb-2">Upload File Excel *</label>
              <input type="file" id="excelFileInput" accept=".xlsx,.xls" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
              <p class="text-xs text-gray-500 mt-2">File format: .xlsx atau .xls</p>
            </div>

            <div class="bg-blue-50 rounded-lg p-4">
              <p class="text-sm text-blue-800">
                <strong>üìù Catatan:</strong> Mata pelajaran di file Excel akan diabaikan. Semua soal akan diimpor dengan mata pelajaran yang dipilih di atas.
              </p>
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" id="cancelImport" class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition">
                Batal
              </button>
              <button type="submit" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition">
                üì§ Import
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('cancelImport').onclick = () => {
        document.body.removeChild(modal);
      };

      document.getElementById('importExcelForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const selectedSubject = document.getElementById('importSubject').value;
        const fileInput = document.getElementById('excelFileInput');
        const file = fileInput.files[0];

        if (!selectedSubject || !file) {
          showToast('Pilih mata pelajaran dan file Excel!', 'error');
          return;
        }

        document.body.removeChild(modal);
        await handleExcelImport(file, selectedSubject);
      };
    }

    async function handleExcelImport(file, selectedSubject) {
      showToast('Sedang memproses file Excel...', 'info');

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          // Find header row
          let headerRowIndex = -1;
          for (let i = 0; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row[0] && row[0].toString().toLowerCase().includes('tipe')) {
              headerRowIndex = i;
              break;
            }
          }

          if (headerRowIndex === -1) {
            showToast('Format Excel salah! Header tidak ditemukan.', 'error');
            return;
          }

          showLoading();
          let imported = 0;
          let failed = 0;
          let skipped = 0;

          const questionsToInsert = [];

          for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
            try {
              const row = jsonData[i];
              
              if (!row || row.length < 11) {
                skipped++;
                continue;
              }

              const type = String(row[0] || '').trim().toLowerCase();
              // row[1] is subject - ignored as per instructions
              const questionText = String(row[2] || '').trim();
              const optionA = String(row[3] || '').trim();
              const optionB = String(row[4] || '').trim();
              const optionC = String(row[5] || '').trim();
              const optionD = String(row[6] || '').trim();
              const optionE = String(row[7] || '').trim();
              const answer = String(row[8] || '').trim().toUpperCase();
              const difficulty = String(row[9] || '').trim().toLowerCase();
              const points = parseInt(row[10]) || 1;

              if (!type || !questionText || !answer || !optionA || !optionB || !optionC || !optionD || !optionE) {
                skipped++;
                continue;
              }

              if (type !== 'pg' && type !== 'pgk') {
                skipped++;
                continue;
              }

              let correctAnswer = '';
              let correctAnswersArray = '';

              if (type === 'pg') {
                if (!['A', 'B', 'C', 'D', 'E'].includes(answer)) {
                  skipped++;
                  continue;
                }
                correctAnswer = answer;
              } else {
                const answers = answer.split(',').map(a => a.trim()).filter(a => ['A', 'B', 'C', 'D', 'E'].includes(a));
                if (answers.length === 0) {
                  skipped++;
                  continue;
                }
                correctAnswersArray = answers.join(',');
              }

              const validDifficulty = ['easy', 'medium', 'hard'].includes(difficulty) ? difficulty : 'medium';

              questionsToInsert.push({
                type,
                subject: selectedSubject,
                question_text: questionText,
                option_a: optionA,
                option_b: optionB,
                option_c: optionC,
                option_d: optionD,
                option_e: optionE,
                correct_answer: correctAnswer,
                correct_answers: correctAnswersArray,
                difficulty: validDifficulty,
                points
              });
            } catch (rowError) {
              failed++;
            }
          }

          if (questionsToInsert.length > 0) {
            try {
              // Try batch insert first (max 50 per batch)
              const chunkSize = 50;
              for (let i = 0; i < questionsToInsert.length; i += chunkSize) {
                const chunk = questionsToInsert.slice(i, i + chunkSize);
                const { data, error } = await supabase
                  .from('questions')
                  .insert(chunk)
                  .select();
                
                if (error) {
                  // Fallback to individual inserts for this chunk
                  for (const questionData of chunk) {
                    const result = await addQuestion(questionData);
                    if (result) imported++;
                    else failed++;
                  }
                } else {
                  imported += data.length;
                }
              }
              clearQuestionsCache();
            } catch (error) {
              console.error('Batch insert error:', error);
              // Fallback to individual inserts
              for (const questionData of questionsToInsert) {
                const result = await addQuestion(questionData);
                if (result) imported++;
                else failed++;
              }
            }
          }

          hideLoading();
          
          if (imported > 0) {
            showToast(`Import selesai! Berhasil: ${imported}, Gagal: ${failed}, Dilewati: ${skipped}`, 'success');
            renderBankSoal();
          } else {
            showToast(`Import gagal! Tidak ada soal yang berhasil diimport. Gagal: ${failed}, Dilewati: ${skipped}. Periksa format file Excel Anda.`, 'error');
          }
        } catch (error) {
          hideLoading();
          console.error('Error reading Excel:', error);
          showToast('Gagal membaca file Excel: ' + error.message, 'error');
        }
      };
      
      reader.onerror = (error) => {
        hideLoading();
        showToast('Gagal membaca file Excel', 'error');
      };
      
      reader.readAsArrayBuffer(file);
    }

    async function handleGenerateExam(event) {
      event.preventDefault();
      
      const examTitle = document.getElementById('examTitle').value.trim();
      const examDuration = parseInt(document.getElementById('examDuration').value);
      const totalQuestions = parseInt(document.getElementById('totalQuestions').value);
      const examSubject = document.getElementById('examSubject').value;
      const pgPercent = parseInt(document.getElementById('pgPercent').value) || 0;
      const pgkPercent = parseInt(document.getElementById('pgkPercent').value) || 0;
      const isOpenBook = document.getElementById('isOpenBook').checked;
      
      if (!examTitle || examDuration <= 0 || totalQuestions <= 0 || !examSubject) {
        showToast('Semua field wajib diisi dengan benar!', 'error');
        return;
      }

      const totalTypePercent = pgPercent + pgkPercent;
      if (totalTypePercent !== 100) {
        showToast(`Total bobot tipe soal harus 100%! Saat ini: ${totalTypePercent}%`, 'error');
        return;
      }

      showLoading();
      const availableQuestions = await getQuestions(examSubject);
      
      const pgCount = Math.round((pgPercent / 100) * totalQuestions);
      const pgkCount = totalQuestions - pgCount;
      
      const pgQuestions = availableQuestions.filter(q => q.type === 'pg');
      const pgkQuestions = availableQuestions.filter(q => q.type === 'pgk');

      if (pgQuestions.length < pgCount) {
        hideLoading();
        showToast(`Soal PG tidak cukup! Tersedia ${pgQuestions.length}, dibutuhkan ${pgCount}`, 'error');
        return;
      }
      if (pgkQuestions.length < pgkCount) {
        hideLoading();
        showToast(`Soal PGK tidak cukup! Tersedia ${pgkQuestions.length}, dibutuhkan ${pgkCount}`, 'error');
        return;
      }

      const examToken = generateId().substring(0, 8).toUpperCase();

      const result = await addExam({
        token: examToken,
        title: examTitle,
        duration: examDuration,
        total_questions: totalQuestions,
        subject: examSubject,
        pg_percent: pgPercent,
        pgk_percent: pgkPercent,
        pg_count: pgCount,
        pgk_count: pgkCount,
        is_open_book: isOpenBook
      });
      hideLoading();

      if (result) {
        showToast(`Token ujian berhasil dibuat: ${examToken}`, 'success');
        document.getElementById('examForm').reset();
        document.getElementById('examDuration').value = 90;
        document.getElementById('totalQuestions').value = 50;
        document.getElementById('pgPercent').value = 70;
        document.getElementById('pgkPercent').value = 30;
        updateTotalTypePercent();
        renderExamManagement();
      }
    }

    function updateTotalTypePercent() {
      const pgPercent = parseInt(document.getElementById('pgPercent').value) || 0;
      const pgkPercent = parseInt(document.getElementById('pgkPercent').value) || 0;
      const total = pgPercent + pgkPercent;
      
      const totalDisplay = document.getElementById('totalTypePercentDisplay');
      if (totalDisplay) {
        totalDisplay.textContent = `${total}%`;
        totalDisplay.className = total === 100 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
      }
    }

    async function handleDeleteExam(id) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-2xl">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Konfirmasi Hapus</h3>
          <p class="text-gray-600 mb-6">Yakin ingin menghapus token ujian ini?</p>
          <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
              Batal
            </button>
            <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
              Hapus
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelDelete').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('confirmDelete').onclick = async () => {
        document.body.removeChild(modal);
        showLoading();
        const success = await deleteExam(id);
        hideLoading();

        if (success) {
          showToast('Token ujian berhasil dihapus!', 'success');
          renderExamManagement();
        }
      };
    }

    async function downloadExcelReport() {
      showLoading();
      const sessions = await getAllSessions();
      hideLoading();
      
      const wb = XLSX.utils.book_new();
      
      const wsData = [
        ['LAPORAN HASIL UJIAN CBT'],
        ['Tanggal: ' + new Date().toLocaleDateString('id-ID')],
        [],
        ['Nama', 'Kelas', 'Mata Pelajaran', 'Status', 'Soal Terjawab', 'Benar', 'Salah', 'Nilai', 'Progress (%)', 'Sisa Waktu', 'Pelanggaran']
      ];

      sessions.forEach(record => {
        const progress = Math.round((record.answered_count / record.total_questions) * 100);
        const hours = Math.floor(record.remaining_seconds / 3600);
        const minutes = Math.floor((record.remaining_seconds % 3600) / 60);
        const seconds = record.remaining_seconds % 60;
        const remainingTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        const status = record.status === 'active' ? `Mengerjakan ${record.exam_title}` : 'Selesai';
        const score = record.score || '-';
        const correctCount = record.correct_count || 0;
        const wrongCount = record.answered_count - correctCount;
        const violations = record.violation_count || 0;
        
        wsData.push([
          record.student_name,
          record.student_class,
          record.exam_title,
          status,
          record.answered_count,
          correctCount,
          wrongCount,
          score,
          progress,
          remainingTime,
          violations
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      ws['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 30 }, { wch: 30 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 12 }];
      XLSX.utils.book_append_sheet(wb, ws, 'Laporan Ujian');
      XLSX.writeFile(wb, `Laporan_Ujian_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('Laporan Excel berhasil diunduh!', 'success');
    }

    async function showStatistics() {
      showLoading();
      const sessions = await getAllSessions();
      hideLoading();
      
      const total = sessions.length;
      const finished = sessions.filter(r => r.status === 'finished').length;
      const active = sessions.filter(r => r.status === 'active').length;
      
      let avgAnswered = 0;
      let avgProgress = 0;
      
      if (total > 0) {
        const totalAnswered = sessions.reduce((sum, r) => sum + r.answered_count, 0);
        const totalPossible = sessions.reduce((sum, r) => sum + r.total_questions, 0);
        avgAnswered = Math.round(totalAnswered / total);
        avgProgress = totalPossible > 0 ? Math.round((totalAnswered / totalPossible) * 100) : 0;
      }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-2xl mx-4 shadow-2xl">
          <h3 class="text-2xl font-bold text-gray-900 mb-6">üìä Statistik Ujian</h3>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-blue-50 rounded-lg p-4">
              <p class="text-sm text-blue-600 mb-1">Total Peserta</p>
              <p class="text-3xl font-bold text-blue-700">${total}</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4">
              <p class="text-sm text-green-600 mb-1">Selesai</p>
              <p class="text-3xl font-bold text-green-700">${finished}</p>
            </div>
            <div class="bg-orange-50 rounded-lg p-4">
              <p class="text-sm text-orange-600 mb-1">Sedang Mengerjakan</p>
              <p class="text-3xl font-bold text-orange-700">${active}</p>
            </div>
            <div class="bg-purple-50 rounded-lg p-4">
              <p class="text-sm text-purple-600 mb-1">Rata-rata Jawaban</p>
              <p class="text-3xl font-bold text-purple-700">${avgAnswered}</p>
            </div>
          </div>

          <div class="mb-6">
            <p class="text-sm font-medium text-gray-700 mb-2">Rata-rata Progress: ${avgProgress}%</p>
            <div class="w-full bg-gray-200 rounded-full h-6">
              <div class="bg-blue-600 h-6 rounded-full progress-bar flex items-center justify-center text-white text-xs font-bold" style="width: ${avgProgress}%">
                ${avgProgress}%
              </div>
            </div>
          </div>

          <button id="closeStats" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
            Tutup
          </button>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('closeStats').onclick = () => {
        document.body.removeChild(modal);
      };
    }

    // ==================== RENDER FUNCTIONS ====================
    
    function renderStudentInterface() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full flex flex-col" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <div>
                <h1 class="text-2xl font-bold text-gray-900">${appState.examTitle}</h1>
                <p class="text-sm text-gray-600">${appState.studentName} - ${appState.studentClass}</p>
                ${appState.currentExam && !appState.currentExam.is_open_book ? 
                  '<p class="text-xs text-red-600 font-semibold mt-1">üîí Closed Book - Jangan pindah tab!</p>' : 
                  '<p class="text-xs text-blue-600 font-semibold mt-1">üìñ Open Book</p>'}
              </div>
              <div class="flex items-center gap-4">
                <div class="text-center">
                  <p class="text-sm text-gray-600">Sisa Waktu</p>
                  <p id="timer" class="text-2xl font-bold text-red-600">00:00:00</p>
                </div>
                <button onclick="showFinishConfirmation()" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
                  Selesai Ujian
                </button>
              </div>
            </div>
          </nav>

          <div class="flex-1 max-w-7xl w-full mx-auto p-8 flex gap-6">
            <!-- Main Question Area -->
            <div class="flex-1 bg-white rounded-xl shadow-xl p-8">
              <div id="questionContent"></div>
            </div>

            <!-- Question Navigator Sidebar -->
            <div class="w-80 bg-white rounded-xl shadow-xl p-6">
              <h3 class="text-lg font-bold text-gray-900 mb-4">Navigasi Soal</h3>
              <div id="questionNavigator" class="grid grid-cols-5 gap-2 mb-6"></div>
              
              <div class="space-y-2 text-sm">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded status-answered"></div>
                  <span>Dijawab</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded status-doubtful"></div>
                  <span>Ragu-ragu</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded status-unanswered"></div>
                  <span>Belum Dijawab</span>
                </div>
              </div>
              
              ${appState.currentExam && !appState.currentExam.is_open_book ? `
                <div class="mt-6 p-4 bg-red-50 rounded-lg border-2 border-red-200">
                  <p class="text-xs text-red-800 font-semibold mb-1">‚ö†Ô∏è Pelanggaran: ${appState.violationCount}/3</p>
                  <p class="text-xs text-red-600">Ujian akan diselesaikan otomatis jika 3 kali pindah tab!</p>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      updateTimerDisplay();
      renderQuestionContent();
      renderQuestionNavigator();
    }

    function renderQuestionContent() {
      const container = document.getElementById('questionContent');
      if (!container) return;

      const question = appState.examQuestions[appState.currentQuestionIndex];
      if (!question) return;

      const questionNumber = appState.currentQuestionIndex + 1;
      const currentAnswer = appState.answers.get(questionNumber);

      const isPG = question.type === 'pg';
      const options = ['A', 'B', 'C', 'D', 'E'];
      
      let selectedAnswers = [];
      if (currentAnswer && currentAnswer.answer) {
        selectedAnswers = currentAnswer.answer.split(',').filter(a => a);
      }

      container.innerHTML = `
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-gray-900">Soal ${questionNumber} dari ${appState.totalQuestions}</h2>
            <span class="${isPG ? 'difficulty-easy' : 'difficulty-medium'}">${isPG ? 'PILIHAN GANDA' : 'PG KOMPLEKS'}</span>
          </div>
          <p class="text-lg text-gray-800 mb-6 leading-relaxed">${question.question_text}</p>
        </div>

        <div class="space-y-3 mb-8">
          ${options.map(opt => {
            const optionText = question['option_' + opt.toLowerCase()];
            const isSelected = isPG ? currentAnswer?.answer === opt : selectedAnswers.includes(opt);
            
            if (isPG) {
              return `
                <div onclick="selectAnswer('${opt}')" 
                     class="option-card border-2 rounded-lg p-4 ${isSelected ? 'option-selected' : 'border-gray-300'}">
                  <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full border-2 ${isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-400'} flex items-center justify-center">
                      ${isSelected ? '<div class="w-3 h-3 rounded-full bg-white"></div>' : ''}
                    </div>
                    <span class="font-semibold text-gray-900">${opt}.</span>
                    <span class="text-gray-800">${optionText}</span>
                  </div>
                </div>
              `;
            } else {
              return `
                <div onclick="togglePGKAnswer('${opt}')" 
                     class="option-card border-2 rounded-lg p-4 cursor-pointer ${isSelected ? 'option-selected' : 'border-gray-300'}">
                  <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded border-2 ${isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-400'} flex items-center justify-center">
                      ${isSelected ? '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' : ''}
                    </div>
                    <span class="font-semibold text-gray-900">${opt}.</span>
                    <span class="text-gray-800">${optionText}</span>
                  </div>
                </div>
              `;
            }
          }).join('')}
        </div>

        <div class="flex justify-between items-center pt-6 border-t">
          <button onclick="previousQuestion()" 
                  class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition ${appState.currentQuestionIndex === 0 ? 'btn-disabled' : ''}">
            ‚Üê Sebelumnya
          </button>
          
          <button onclick="markAsDoubtful()" class="px-6 py-3 bg-yellow-500 text-white rounded-lg font-medium hover:bg-yellow-600 transition">
            ü§î Ragu-ragu
          </button>
          
          <button onclick="nextQuestion()" 
                  class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition ${appState.currentQuestionIndex === appState.totalQuestions - 1 ? 'btn-disabled' : ''}">
            Selanjutnya ‚Üí
          </button>
        </div>
      `;
    }

    function renderQuestionNavigator() {
      const container = document.getElementById('questionNavigator');
      if (!container) return;

      container.innerHTML = appState.examQuestions.map((_, index) => {
        const questionNumber = index + 1;
        const answer = appState.answers.get(questionNumber);
        
        let statusClass = 'status-unanswered';
        if (answer) {
          if (answer.isDoubtful) {
            statusClass = 'status-doubtful';
          } else if (answer.answer) {
            statusClass = 'status-answered';
          }
        }
        
        if (index === appState.currentQuestionIndex) {
          statusClass += ' status-current';
        }

        return `
          <button onclick="goToQuestion(${index})" 
                  class="question-number w-10 h-10 rounded font-bold ${statusClass}">
            ${questionNumber}
          </button>
        `;
      }).join('');
    }

    function renderRoleSelection() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full flex items-center justify-center p-8" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);">
          <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-4xl w-full">
            <div class="text-center mb-12">
              <h1 class="text-5xl font-bold text-gray-900 mb-2">CBT Professional System</h1>
              <p class="text-xl text-gray-600">Sistem Computer Based Test Profesional</p>
              ${isSupabaseConfigured ? '<p class="text-sm text-green-600 mt-2">‚úÖ Terhubung ke Supabase</p>' : '<p class="text-sm text-red-600 mt-2">‚ùå Koneksi Supabase Gagal</p>'}
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <div class="border-2 border-blue-500 rounded-xl p-8 hover:shadow-lg transition cursor-pointer" onclick="showAdminLogin()">
                <div class="text-center">
                  <svg class="w-20 h-20 mx-auto mb-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <h3 class="text-2xl font-bold text-gray-900 mb-2">Administrator</h3>
                  <p class="text-gray-600">Kelola sistem ujian</p>
                </div>
              </div>

              <div class="border-2 border-green-500 rounded-xl p-8 hover:shadow-lg transition cursor-pointer" onclick="showStudentLogin()">
                <div class="text-center">
                  <svg class="w-20 h-20 mx-auto text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <h3 class="text-2xl font-bold text-gray-900 mb-2">Siswa</h3>
                  <p class="text-gray-600">Ikuti ujian CBT</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showAdminLogin() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full flex items-center justify-center p-8" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);">
          <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md w-full">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-4 rounded-lg mb-6 overflow-hidden relative">
              <div class="whitespace-nowrap animate-marquee inline-block">
                ‚ú® CBT - EXAM _ By Ipoel ‚ú® | üìö E-Ujian System - SMK Negeri 4 Jakarta | üéì Tahun Pelajaran 2025/2026 | üí° Ujian Makin Asik Tanpa Mencontek | ‚ú® CBT - EXAM _ By Ipoel ‚ú® | üìö E-Ujian System - SMK Negeri 4 Jakarta | 
              </div>
            </div>

            <button onclick="backToRoleSelection()" class="text-gray-600 hover:text-gray-900 mb-6 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              Kembali
            </button>

            <div class="text-center mb-8">
              <h2 class="text-3xl font-bold text-gray-900">Admin Login</h2>
            </div>
            
            <form onsubmit="loginAdmin(event)" class="space-y-6">
              <div>
                <label for="adminUsername" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                <input type="text" id="adminUsername" required value="admin"
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
              </div>

              <div>
                <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" id="adminPassword" required value="admin123"
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
              </div>

              <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                Login
              </button>
            </form>

            </div>
        </div>
      `;
    }

    function loginAdmin(event) {
      event.preventDefault();
      const username = document.getElementById('adminUsername').value;
      const password = document.getElementById('adminPassword').value;
      
      if (username === 'admin' && password === 'admin123') {
        showToast('Login berhasil!', 'success');
        appState.currentRole = 'admin';
        appState.currentView = 'admin-menu';
        saveAdminStateToLocalStorage();
        renderAdminMenu();
      } else {
        showToast('Username atau password salah!', 'error');
      }
    }

    function showStudentLogin() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full flex items-center justify-center p-8" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md w-full">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 px-4 rounded-lg mb-6 overflow-hidden relative">
              <div class="whitespace-nowrap animate-marquee inline-block">
                ‚ú® CBT - EXAM _ By Ipoel ‚ú® | üìö E-Ujian System - SMK Negeri 4 Jakarta | üéì Tahun Pelajaran 2025/2026 | üí° Ujian Makin Asik Tanpa Mencontek | ‚ú® CBT - EXAM _ By Ipoel ‚ú® | üìö E-Ujian System - SMK Negeri 4 Jakarta | 
              </div>
            </div>

            <button onclick="backToRoleSelection()" class="text-gray-600 hover:text-gray-900 mb-6 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              Kembali
            </button>

            <div class="text-center mb-8">
              <h2 class="text-3xl font-bold text-gray-900">Login Siswa</h2>
            </div>
            
            <form onsubmit="handleStudentLogin(event)" class="space-y-6">
              <div>
                <label for="studentUserId" class="block text-sm font-medium text-gray-700 mb-2">NISN / NIS</label>
                <input type="text" id="studentUserId" required placeholder="Masukkan NISN/NIS"
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
              </div>

              <div>
                <label for="studentPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" id="studentPassword" required placeholder="Masukkan password"
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
              </div>

              <button type="submit" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                Login
              </button>
            </form>
          </div>
        </div>
      `;
    }

    let monitoringInterval = null;

    async function refreshMonitoring() {
      clearSessionsCache();
      await renderMonitoring();
      showToast('Data monitoring berhasil diperbarui!', 'success');
    }

    function backToRoleSelection() {
      if (appState.timerInterval) {
        clearInterval(appState.timerInterval);
      }
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
      }
      
      removeBrowserLock();
      clearStateFromLocalStorage();
      clearAdminStateFromLocalStorage();
      clearLoggedUser();
      
      appState.currentView = 'role-selection';
      appState.currentRole = null;
      appState.loggedUser = null;
      appState.studentId = null;
      appState.studentName = '';
      appState.studentClass = '';
      appState.examSessionId = null;
      appState.currentQuestionIndex = 0;
      appState.answers.clear();
      appState.examQuestions = [];
      appState.violationCount = 0;
      renderRoleSelection();
    }

    function renderAdminMenu() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <h1 class="text-2xl font-bold text-gray-900">CBT Admin Panel</h1>
              <button onclick="backToRoleSelection()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Logout
              </button>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto p-8">
            <div class="bg-blue-50 rounded-lg p-4 mb-6">
              <p class="text-sm text-blue-800">
                <strong>üéØ Info Sistem:</strong> Sistem dioptimalkan untuk 200 siswa dengan caching otomatis. Data akan di-refresh setiap 5 menit untuk performa terbaik.
              </p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-6">
              <div onclick="renderSubjectManagement()" class="bg-white rounded-xl p-8 hover:shadow-2xl transition cursor-pointer">
                <svg class="w-16 h-16 text-purple-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Mata Pelajaran</h3>
                <p class="text-gray-600">Kelola daftar mata pelajaran</p>
              </div>

              <div onclick="renderUserManagement()" class="bg-white rounded-xl p-8 hover:shadow-2xl transition cursor-pointer">
                <svg class="w-16 h-16 text-blue-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Manajemen User</h3>
                <p class="text-gray-600">Kelola akun siswa dan guru</p>
              </div>

              <div onclick="renderBankSoal()" class="bg-white rounded-xl p-8 hover:shadow-2xl transition cursor-pointer">
                <svg class="w-16 h-16 text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Bank Soal</h3>
                <p class="text-gray-600">Kelola koleksi soal ujian</p>
              </div>

              <div onclick="renderExamManagement()" class="bg-white rounded-xl p-8 hover:shadow-2xl transition cursor-pointer">
                <svg class="w-16 h-16 text-orange-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                </svg>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Generate Token</h3>
                <p class="text-gray-600">Buat token ujian baru</p>
              </div>

              <div onclick="renderMonitoring()" class="bg-white rounded-xl p-8 hover:shadow-2xl transition cursor-pointer">
                <svg class="w-16 h-16 text-red-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Monitoring</h3>
                <p class="text-gray-600">Pantau aktivitas ujian</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function renderSubjectManagement() {
      appState.currentView = 'subject-management';
      saveAdminStateToLocalStorage();
      
      showLoading();
      const subjects = await getSubjects();
      hideLoading();

      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full" style="background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <h1 class="text-2xl font-bold text-gray-900">Manajemen Mata Pelajaran</h1>
              <button onclick="renderAdminMenu()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                ‚Üê Kembali
              </button>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto p-8">
            <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
              <h3 class="text-xl font-bold text-gray-900 mb-4">‚ûï Tambah Mata Pelajaran</h3>
              <form id="subjectForm" onsubmit="handleAddSubject(event)" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label for="subjectCode" class="block text-sm font-medium text-gray-700 mb-2">Kode Mapel *</label>
                    <input type="text" id="subjectCode" required placeholder="Contoh: MTK"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                  </div>
                  <div>
                    <label for="subjectName" class="block text-sm font-medium text-gray-700 mb-2">Nama Mapel *</label>
                    <input type="text" id="subjectName" required placeholder="Contoh: Matematika"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                  </div>
                </div>
                <div>
                  <label for="subjectDescription" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                  <textarea id="subjectDescription" rows="3" placeholder="Keterangan tambahan (opsional)"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500"></textarea>
                </div>
                <button type="submit" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">
                  üíæ Simpan Mata Pelajaran
                </button>
              </form>
            </div>

            <div class="bg-white rounded-xl shadow-xl p-8">
              <h3 class="text-xl font-bold text-gray-900 mb-4">üìö Daftar Mata Pelajaran (${subjects.length})</h3>
              ${subjects.length === 0 ? `
                <div class="text-center py-12">
                  <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <p class="text-gray-500">Belum ada mata pelajaran</p>
                </div>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-purple-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Kode</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Nama</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Deskripsi</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Aksi</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      ${subjects.map(subject => `
                        <tr class="hover:bg-gray-50">
                          <td class="px-6 py-4 font-mono font-bold text-purple-600">${subject.code}</td>
                          <td class="px-6 py-4 text-gray-900">${subject.name}</td>
                          <td class="px-6 py-4 text-gray-600">${subject.description || '-'}</td>
                          <td class="px-6 py-4 text-center">
                            <button onclick="handleDeleteSubject('${subject.id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm">
                              üóëÔ∏è Hapus
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    async function renderUserManagement() {
      appState.currentView = 'user-management';
      saveAdminStateToLocalStorage();
      
      showLoading();
      const users = await getUsers();
      hideLoading();

      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <h1 class="text-2xl font-bold text-gray-900">Manajemen User</h1>
              <button onclick="renderAdminMenu()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                ‚Üê Kembali
              </button>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto p-8">
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div class="bg-white rounded-xl shadow-xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4">‚ûï Tambah User</h3>
                <form id="userForm" onsubmit="handleAddUser(event)" class="space-y-4">
                  <div>
                    <label for="userId" class="block text-sm font-medium text-gray-700 mb-2">NISN / User ID *</label>
                    <input type="text" id="userId" required placeholder="Contoh: 1234567890"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>
                  <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                    <input type="text" id="userName" required placeholder="Contoh: Ahmad Fauzi"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>
                  <div>
                    <label for="userRole" class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                    <select id="userRole" onchange="toggleClassField()" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                      <option value="student">Siswa</option>
                      <option value="teacher">Guru</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>
                  <div id="classFieldContainer">
                    <label for="userClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label>
                    <input type="text" id="userClass" placeholder="Contoh: X-TAV"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>
                  <div>
                    <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                    <input type="password" id="userPassword" required placeholder="Password default"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>
                  <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                    üíæ Simpan User
                  </button>
                </form>
              </div>

              <div class="bg-white rounded-xl shadow-xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4">üì§ Import dari Excel</h3>
                <div class="space-y-4">
                  <p class="text-sm text-gray-600">Import user secara massal menggunakan file Excel (.xlsx)</p>
                  
                  <button onclick="downloadUserTemplate()" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                    üì• Download Template Excel
                  </button>
                  
                  <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <label for="excelUpload" class="cursor-pointer">
                      <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                      </svg>
                      <p class="text-sm text-gray-600 mb-2">Klik untuk upload Excel</p>
                      <p class="text-xs text-gray-500">Format: .xlsx atau .xls</p>
                      <input type="file" id="excelUpload" accept=".xlsx,.xls" onchange="handleExcelUpload(event)" class="hidden">
                    </label>
                  </div>

                  <div class="bg-yellow-50 rounded-lg p-4">
                    <p class="text-xs text-yellow-800">
                      <strong>üí° Tips:</strong> Gunakan template Excel untuk import massal hingga ratusan user sekaligus!
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-xl p-8">
              <h3 class="text-xl font-bold text-gray-900 mb-4">üë• Daftar User (${users.length})</h3>
              ${users.length === 0 ? `
                <div class="text-center py-12">
                  <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                  <p class="text-gray-500">Belum ada user terdaftar</p>
                </div>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-blue-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">User ID</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Nama</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Kelas</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Role</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Aksi</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      ${users.map(user => `
                        <tr class="hover:bg-gray-50">
                          <td class="px-6 py-4 font-mono text-blue-600">${user.user_id}</td>
                          <td class="px-6 py-4 text-gray-900">${user.name}</td>
                          <td class="px-6 py-4 text-gray-600">${user.class || '-'}</td>
                          <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${
                              user.role === 'admin' ? 'bg-red-100 text-red-800' :
                              user.role === 'teacher' ? 'bg-green-100 text-green-800' :
                              'bg-blue-100 text-blue-800'
                            }">
                              ${user.role}
                            </span>
                          </td>
                          <td class="px-6 py-4 text-center">
                            <button onclick="handleDeleteUser('${user.id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm">
                              üóëÔ∏è Hapus
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function toggleClassField() {
      const role = document.getElementById('userRole').value;
      const classField = document.getElementById('classFieldContainer');
      
      if (role === 'student') {
        classField.style.display = 'block';
        document.getElementById('userClass').required = true;
      } else {
        classField.style.display = 'none';
        document.getElementById('userClass').required = false;
      }
    }

    async function renderBankSoal() {
      appState.currentView = 'bank-soal';
      saveAdminStateToLocalStorage();
      
      showLoading();
      const subjects = await getSubjects();
      const questions = await getQuestions(appState.currentSubjectFilter);
      hideLoading();

      const app = document.getElementById('app');
      
      const allQuestions = appState.currentSubjectFilter === 'all' ? await getQuestions('all') : questions;
      
      app.innerHTML = `
        <div class="min-h-full" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <h1 class="text-2xl font-bold text-gray-900">Bank Soal</h1>
              <button onclick="renderAdminMenu()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                ‚Üê Kembali
              </button>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto p-8">
            <!-- Bulk Actions Bar -->
            <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
              <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-2">
                  <button onclick="toggleBulkEditMode()" class="px-4 py-2 ${appState.bulkEditMode ? 'bg-orange-600' : 'bg-blue-600'} text-white rounded-lg font-semibold hover:opacity-90 transition">
                    ${appState.bulkEditMode ? '‚ùå Batal Edit Massal' : '‚úèÔ∏è Edit Massal'}
                  </button>
                  ${appState.bulkEditMode ? `
                    <button onclick="selectAllQuestions()" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">
                      ${appState.selectedQuestions.size === questions.length ? '‚òê Batalkan Semua' : '‚òëÔ∏è Pilih Semua'}
                    </button>
                    <button onclick="showBulkEditModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition ${appState.selectedQuestions.size === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                      üíæ Terapkan (${appState.selectedQuestions.size})
                    </button>
                  ` : ''}
                </div>
                
                <div class="flex gap-2">
                  <button onclick="downloadWordTemplate()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                    üì• Template Excel
                  </button>
                  <button onclick="showImportExcelModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">
                    üì§ Import Excel
                  </button>
                </div>
              </div>
            </div>

            <!-- Add Question Form -->
            <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
              <h3 class="text-xl font-bold text-gray-900 mb-4">‚ûï Tambah Soal Baru</h3>
              <form id="questionForm" onsubmit="handleAddQuestion(event)" class="space-y-4">
                <div class="grid md:grid-cols-3 gap-4">
                  <div>
                    <label for="questionType" class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal *</label>
                    <select id="questionType" onchange="toggleAnswerType()" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                      <option value="pg">Pilihan Ganda (PG)</option>
                      <option value="pgk">PG Kompleks (PGK)</option>
                    </select>
                  </div>
                  <div>
                    <label for="questionSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran *</label>
                    <select id="questionSubject" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                      <option value="">-- Pilih Mapel --</option>
                      ${subjects.map(s => `<option value="${s.code}">${s.code} - ${s.name}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-2">Tingkat Kesulitan *</label>
                    <select id="difficulty" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                      <option value="easy">Mudah</option>
                      <option value="medium">Sedang</option>
                      <option value="hard">Sulit</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label for="questionText" class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan *</label>
                  <textarea id="questionText" required rows="3" placeholder="Tulis pertanyaan di sini..."
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500"></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label for="optionA" class="block text-sm font-medium text-gray-700 mb-2">Pilihan A *</label>
                    <input type="text" id="optionA" required placeholder="Jawaban A"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                  </div>
                  <div>
                    <label for="optionB" class="block text-sm font-medium text-gray-700 mb-2">Pilihan B *</label>
                    <input type="text" id="optionB" required placeholder="Jawaban B"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                  </div>
                  <div>
                    <label for="optionC" class="block text-sm font-medium text-gray-700 mb-2">Pilihan C *</label>
                    <input type="text" id="optionC" required placeholder="Jawaban C"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                  </div>
                  <div>
                    <label for="optionD" class="block text-sm font-medium text-gray-700 mb-2">Pilihan D *</label>
                    <input type="text" id="optionD" required placeholder="Jawaban D"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                  </div>
                  <div>
                    <label for="optionE" class="block text-sm font-medium text-gray-700 mb-2">Pilihan E *</label>
                    <input type="text" id="optionE" required placeholder="Jawaban E"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                  </div>
                  <div>
                    <label for="points" class="block text-sm font-medium text-gray-700 mb-2">Poin Soal *</label>
                    <input type="number" id="points" required min="0" value="1"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                  </div>
                </div>

                <!-- PG Answer -->
                <div id="pgAnswerSection">
                  <label for="correctAnswer" class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar *</label>
                  <select id="correctAnswer" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                  </select>
                </div>

                <!-- PGK Answers -->
                <div id="pgkAnswerSection" style="display: none;">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Jawaban Benar (bisa lebih dari 1) *</label>
                  <div class="flex gap-4">
                    <label class="flex items-center gap-2">
                      <input type="checkbox" id="ansA" value="A" class="w-5 h-5">
                      <span>A</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input type="checkbox" id="ansB" value="B" class="w-5 h-5">
                      <span>B</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input type="checkbox" id="ansC" value="C" class="w-5 h-5">
                      <span>C</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input type="checkbox" id="ansD" value="D" class="w-5 h-5">
                      <span>D</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input type="checkbox" id="ansE" value="E" class="w-5 h-5">
                      <span>E</span>
                    </label>
                  </div>
                </div>

                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                  üíæ Simpan Soal
                </button>
              </form>
            </div>

            <!-- Filter -->
            <div class="bg-white rounded-xl shadow-xl p-6 mb-6">
              <div class="flex flex-wrap gap-2">
                <button onclick="filterBySubject('all')" class="px-4 py-2 ${appState.currentSubjectFilter === 'all' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'} rounded-lg font-medium hover:opacity-90 transition">
                  Semua (${allQuestions.length})
                </button>
                ${subjects.map(s => `
                  <button onclick="filterBySubject('${s.code}')" class="px-4 py-2 ${appState.currentSubjectFilter === s.code ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'} rounded-lg font-medium hover:opacity-90 transition">
                    ${s.code}
                  </button>
                `).join('')}
              </div>
            </div>

            <!-- Questions List -->
            <div class="bg-white rounded-xl shadow-xl p-8">
              <h3 class="text-xl font-bold text-gray-900 mb-4">
                üìù Daftar Soal ${appState.currentSubjectFilter === 'all' ? '' : `- ${appState.currentSubjectFilter}`} (${questions.length})
              </h3>
              ${questions.length === 0 ? `
                <div class="text-center py-12">
                  <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <p class="text-gray-500">Belum ada soal tersedia</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${questions.map((q, idx) => `
                    <div class="border-2 ${appState.selectedQuestions.has(q.id) ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-lg p-6 hover:shadow-md transition">
                      <div class="flex items-start gap-4">
                        ${appState.bulkEditMode ? `
                          <input type="checkbox" 
                                 ${appState.selectedQuestions.has(q.id) ? 'checked' : ''}
                                 onchange="toggleQuestionSelection('${q.id}')"
                                 class="w-6 h-6 mt-1">
                        ` : ''}
                        <div class="flex-1">
                          <div class="flex items-center gap-2 mb-2">
                            <span class="font-bold text-gray-900">#{idx + 1}</span>
                            <span class="${q.type === 'pg' ? 'difficulty-easy' : 'difficulty-medium'}">${q.type.toUpperCase()}</span>
                            <span class="difficulty-${q.difficulty}">${
                              q.difficulty === 'easy' ? 'MUDAH' :
                              q.difficulty === 'medium' ? 'SEDANG' : 'SULIT'
                            }</span>
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">${q.subject}</span>
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">${q.points} poin</span>
                          </div>
                          <p class="text-gray-900 mb-3 font-medium">${q.question_text}</p>
                          <div class="grid md:grid-cols-2 gap-2 text-sm">
                            <div class="flex items-start gap-2">
                              <span class="font-semibold text-gray-700">A.</span>
                              <span class="text-gray-600">${q.option_a}</span>
                            </div>
                            <div class="flex items-start gap-2">
                              <span class="font-semibold text-gray-700">B.</span>
                              <span class="text-gray-600">${q.option_b}</span>
                            </div>
                            <div class="flex items-start gap-2">
                              <span class="font-semibold text-gray-700">C.</span>
                              <span class="text-gray-600">${q.option_c}</span>
                            </div>
                            <div class="flex items-start gap-2">
                              <span class="font-semibold text-gray-700">D.</span>
                              <span class="text-gray-600">${q.option_d}</span>
                            </div>
                            <div class="flex items-start gap-2">
                              <span class="font-semibold text-gray-700">E.</span>
                              <span class="text-gray-600">${q.option_e}</span>
                            </div>
                          </div>
                          <div class="mt-3 p-3 bg-green-50 rounded">
                            <span class="text-sm font-semibold text-green-800">
                              ‚úì Jawaban: ${q.type === 'pg' ? q.correct_answer : q.correct_answers}
                            </span>
                          </div>
                        </div>
                        ${!appState.bulkEditMode ? `
                          <button onclick="handleDeleteQuestion('${q.id}')" class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm">
                            üóëÔ∏è
                          </button>
                        ` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    async function renderExamManagement() {
      appState.currentView = 'exam-management';
      saveAdminStateToLocalStorage();
      
      showLoading();
      const subjects = await getSubjects();
      const exams = await getExams();
      hideLoading();

      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-full" style="background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <h1 class="text-2xl font-bold text-gray-900">Generate Token Ujian</h1>
              <button onclick="renderAdminMenu()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                ‚Üê Kembali
              </button>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto p-8">
            <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
              <h3 class="text-xl font-bold text-gray-900 mb-4">üé´ Buat Token Ujian Baru</h3>
              <form id="examForm" onsubmit="handleGenerateExam(event)" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label for="examTitle" class="block text-sm font-medium text-gray-700 mb-2">Judul Ujian *</label>
                    <input type="text" id="examTitle" required placeholder="Contoh: UTS Matematika Semester 1"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                  </div>
                  <div>
                    <label for="examSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran *</label>
                    <select id="examSubject" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                      <option value="">-- Pilih Mata Pelajaran --</option>
                      ${subjects.map(s => `<option value="${s.code}">${s.code} - ${s.name}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <label for="examDuration" class="block text-sm font-medium text-gray-700 mb-2">Durasi (menit) *</label>
                    <input type="number" id="examDuration" required min="1" value="90"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                  </div>
                  <div>
                    <label for="totalQuestions" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Soal *</label>
                    <input type="number" id="totalQuestions" required min="1" value="50"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                  </div>
                </div>

                <div class="bg-blue-50 rounded-lg p-6">
                  <h4 class="font-bold text-gray-900 mb-3">‚öôÔ∏è Pengaturan Tipe Soal</h4>
                  <div class="grid md:grid-cols-2 gap-4 mb-3">
                    <div>
                      <label for="pgPercent" class="block text-sm font-medium text-gray-700 mb-2">PG (%)</label>
                      <input type="number" id="pgPercent" min="0" max="100" value="70" oninput="updateTotalTypePercent()"
                             class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                    </div>
                    <div>
                      <label for="pgkPercent" class="block text-sm font-medium text-gray-700 mb-2">PGK (%)</label>
                      <input type="number" id="pgkPercent" min="0" max="100" value="30" oninput="updateTotalTypePercent()"
                             class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                    </div>
                  </div>
                  <div class="text-center">
                    <p class="text-sm text-gray-600 mb-1">Total Bobot Tipe Soal:</p>
                    <p id="totalTypePercentDisplay" class="text-2xl font-bold text-green-600">100%</p>
                    <p class="text-xs text-gray-500 mt-2">Harus 100% agar token bisa dibuat</p>
                  </div>
                </div>

                <div class="bg-yellow-50 rounded-lg p-4">
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="isOpenBook" class="w-5 h-5">
                    <div>
                      <span class="font-semibold text-gray-900">üìñ Open Book</span>
                      <p class="text-xs text-gray-600">Centang jika siswa diperbolehkan membuka tab lain saat ujian</p>
                    </div>
                  </label>
                </div>

                <button type="submit" class="w-full px-6 py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700 transition">
                  üé´ Generate Token Ujian
                </button>
              </form>
            </div>

            <div class="bg-white rounded-xl shadow-xl p-8">
              <h3 class="text-xl font-bold text-gray-900 mb-4">üé´ Daftar Token Ujian (${exams.length})</h3>
              ${exams.length === 0 ? `
                <div class="text-center py-12">
                  <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                  </svg>
                  <p class="text-gray-500">Belum ada token ujian</p>
                </div>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-orange-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Token</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Judul</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Mapel</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Soal</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Durasi</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Tipe</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Mode</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Aksi</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      ${exams.map(exam => `
                        <tr class="hover:bg-gray-50">
                          <td class="px-6 py-4">
                            <span class="font-mono font-bold text-orange-600 text-lg">${exam.token}</span>
                          </td>
                          <td class="px-6 py-4 text-gray-900 font-medium">${exam.title}</td>
                          <td class="px-6 py-4">
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">${exam.subject}</span>
                          </td>
                          <td class="px-6 py-4 text-center font-bold text-gray-900">${exam.total_questions}</td>
                          <td class="px-6 py-4 text-center text-gray-600">${exam.duration} menit</td>
                          <td class="px-6 py-4 text-center text-xs">
                            <div>PG: ${exam.pg_percent}%</div>
                            <div>PGK: ${exam.pgk_percent}%</div>
                          </td>
                          <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${
                              exam.is_open_book ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'
                            }">
                              ${exam.is_open_book ? 'üìñ Open' : 'üîí Closed'}
                            </span>
                          </td>
                          <td class="px-6 py-4 text-center">
                            <button onclick="handleDeleteExam('${exam.id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm">
                              üóëÔ∏è
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
      
      updateTotalTypePercent();
    }

    async function renderMonitoring() {
      appState.currentView = 'monitoring';
      saveAdminStateToLocalStorage();
      
      // Auto-finish expired sessions first
      await autoFinishExpiredSessions();
      
      showLoading();
      const sessions = await getAllSessions(true);
      hideLoading();

      const app = document.getElementById('app');
      
      const activeSessions = sessions.filter(s => s.status === 'active');
      const finishedSessions = sessions.filter(s => s.status === 'finished');
      
      app.innerHTML = `
        <div class="min-h-full" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
          <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
              <h1 class="text-2xl font-bold text-gray-900">Monitoring Ujian Real-time</h1>
              <div class="flex gap-2">
                <button onclick="refreshMonitoring()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                  üîÑ Refresh
                </button>
                <button onclick="renderAdminMenu()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                  ‚Üê Kembali
                </button>
              </div>
            </div>
          </nav>

          <div class="max-w-7xl mx-auto p-8">
            <div class="grid md:grid-cols-4 gap-6 mb-6">
              <div class="bg-white rounded-xl p-6 shadow-xl">
                <p class="text-sm text-gray-600 mb-1">Total Peserta</p>
                <p class="text-4xl font-bold text-blue-600">${sessions.length}</p>
              </div>
              <div class="bg-white rounded-xl p-6 shadow-xl">
                <p class="text-sm text-gray-600 mb-1">Sedang Mengerjakan</p>
                <p class="text-4xl font-bold text-orange-600">${activeSessions.length}</p>
              </div>
              <div class="bg-white rounded-xl p-6 shadow-xl">
                <p class="text-sm text-gray-600 mb-1">Selesai</p>
                <p class="text-4xl font-bold text-green-600">${finishedSessions.length}</p>
              </div>
              <div class="bg-white rounded-xl p-6 shadow-xl">
                <div class="flex gap-2">
                  <button onclick="downloadExcelReport()" class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold">
                    üìä Excel
                  </button>
                  <button onclick="showStatistics()" class="flex-1 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-semibold">
                    üìà Stats
                  </button>
                </div>
              </div>
            </div>

            <!-- Active Sessions -->
            ${activeSessions.length > 0 ? `
              <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">üî• Sedang Mengerjakan (${activeSessions.length})</h3>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-orange-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Nama</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Kelas</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Ujian</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Progress</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Sisa Waktu</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Pelanggaran</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      ${activeSessions.map(record => {
                        const progress = Math.round((record.answered_count / record.total_questions) * 100);
                        const hours = Math.floor(record.remaining_seconds / 3600);
                        const minutes = Math.floor((record.remaining_seconds % 3600) / 60);
                        const seconds = record.remaining_seconds % 60;
                        const remainingTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        const isLowTime = record.remaining_seconds < 300;
                        const violations = record.violation_count || 0;
                        
                        return `
                          <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">${record.student_name}</td>
                            <td class="px-6 py-4 text-gray-600">${record.student_class}</td>
                            <td class="px-6 py-4 text-gray-900">${record.exam_title}</td>
                            <td class="px-6 py-4">
                              <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                  <div class="bg-orange-500 h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-sm font-semibold text-gray-700">${progress}%</span>
                              </div>
                              <p class="text-xs text-gray-500 mt-1">${record.answered_count}/${record.total_questions} soal</p>
                            </td>
                            <td class="px-6 py-4 text-center">
                              <span class="font-mono font-bold ${isLowTime ? 'text-red-600' : 'text-gray-900'}">${remainingTime}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                              <span class="px-2 py-1 rounded text-xs font-semibold ${
                                violations >= 3 ? 'bg-red-100 text-red-800' :
                                violations >= 2 ? 'bg-orange-100 text-orange-800' :
                                violations >= 1 ? 'bg-yellow-100 text-yellow-800' :
                                'bg-green-100 text-green-800'
                              }">
                                ${violations}/3
                              </span>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}

            <!-- Finished Sessions -->
            <div class="bg-white rounded-xl shadow-xl p-8">
              <h3 class="text-xl font-bold text-gray-900 mb-4">‚úÖ Selesai (${finishedSessions.length})</h3>
              ${finishedSessions.length === 0 ? `
                <div class="text-center py-12">
                  <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <p class="text-gray-500">Belum ada ujian yang selesai</p>
                </div>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-green-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Nama</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Kelas</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Ujian</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Nilai</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Benar/Salah</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Waktu Selesai</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      ${finishedSessions.map(record => `
                        <tr class="hover:bg-gray-50">
                          <td class="px-6 py-4 font-medium text-gray-900">${record.student_name}</td>
                          <td class="px-6 py-4 text-gray-600">${record.student_class}</td>
                          <td class="px-6 py-4 text-gray-900">${record.exam_title}</td>
                          <td class="px-6 py-4 text-center">
                            <span class="text-2xl font-bold ${
                              record.score >= 75 ? 'text-green-600' :
                              record.score >= 60 ? 'text-yellow-600' : 'text-red-600'
                            }">
                              ${record.score || '-'}
                            </span>
                          </td>
                          <td class="px-6 py-4 text-center">
                            <span class="text-green-600 font-semibold">${record.correct_count || 0}</span> / 
                            <span class="text-red-600 font-semibold">${record.answered_count - (record.correct_count || 0)}</span>
                          </td>
                          <td class="px-6 py-4 text-center text-sm text-gray-600">
                            ${new Date(record.finished_at).toLocaleString('id-ID')}
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          </div>
        </div>
      `;

      // Auto-refresh every 10 seconds
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
      }
      monitoringInterval = setInterval(async () => {
        if (appState.currentView === 'monitoring') {
          await renderMonitoring();
        }
      }, 10000);
    }

    // Make functions globally accessible
    window.closeViolationWarning = closeViolationWarning;
    window.handleStudentLogin = handleStudentLogin;
    window.studentLogout = studentLogout;
    window.resumeExam = resumeExam;
    window.startNewExam = startNewExam;
    window.backToDashboard = backToDashboard;
    window.selectAnswer = selectAnswer;
    window.togglePGKAnswer = togglePGKAnswer;
    window.markAsDoubtful = markAsDoubtful;
    window.goToQuestion = goToQuestion;
    window.previousQuestion = previousQuestion;
    window.nextQuestion = nextQuestion;
    window.showFinishConfirmation = showFinishConfirmation;
    window.finishExam = finishExam;
    window.showAdminLogin = showAdminLogin;
    window.showStudentLogin = showStudentLogin;
    window.loginAdmin = loginAdmin;
    window.backToRoleSelection = backToRoleSelection;
    window.renderAdminMenu = renderAdminMenu;
    window.renderSubjectManagement = renderSubjectManagement;
    window.renderUserManagement = renderUserManagement;
    window.renderBankSoal = renderBankSoal;
    window.renderExamManagement = renderExamManagement;
    window.renderMonitoring = renderMonitoring;
    window.handleAddSubject = handleAddSubject;
    window.handleDeleteSubject = handleDeleteSubject;
    window.handleAddUser = handleAddUser;
    window.handleDeleteUser = handleDeleteUser;
    window.toggleClassField = toggleClassField;
    window.downloadUserTemplate = downloadUserTemplate;
    window.handleExcelUpload = handleExcelUpload;
    window.handleAddQuestion = handleAddQuestion;
    window.handleDeleteQuestion = handleDeleteQuestion;
    window.toggleAnswerType = toggleAnswerType;
    window.filterBySubject = filterBySubject;
    window.toggleBulkEditMode = toggleBulkEditMode;
    window.toggleQuestionSelection = toggleQuestionSelection;
    window.selectAllQuestions = selectAllQuestions;
    window.showBulkEditModal = showBulkEditModal;
    window.downloadWordTemplate = downloadWordTemplate;
    window.showImportExcelModal = showImportExcelModal;
    window.handleGenerateExam = handleGenerateExam;
    window.updateTotalTypePercent = updateTotalTypePercent;
    window.handleDeleteExam = handleDeleteExam;
    window.downloadExcelReport = downloadExcelReport;
    window.showStatistics = showStatistics;
    window.refreshMonitoring = refreshMonitoring;
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9aec20ac12e3e785',t:'MTc2NTg2NjU4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
